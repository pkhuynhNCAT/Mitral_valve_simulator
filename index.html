<!doctype html>
<html lang="en">
<head>
  <!-- =========================
       SECTION 01: HEAD • META & SEO
       ========================= -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Mitral Valve Repair Simulator — Training & Assessment</title>
  <meta name="description" content="Web-based, high-fidelity mitral valve repair & replacement simulation for training and assessment with AI co-pilot guidance." />
  <meta name="theme-color" content="#0b1220" />
  <!-- Preload fonts (optional, system stack recommended), favicon/data URL placeholders -->
  <!-- <link rel="preload" as="font" href="data:font/woff2;base64,..." crossorigin> -->

  <!-- =========================
       SECTION 02: HEAD • DESIGN TOKENS & GLOBAL CSS
       ========================= -->
  <style>
    :root {
      /* Color system */
      --bg-0:#05070c; --bg-1:#0b1220; --bg-2:#111a2e;
      --fg-0:#ffffff; --fg-1:#cbd5e1; --muted:#8b9bb3;
      --accent:#00d1ff; --accent-2:#ff2d55; --ok:#2ecc71; --warn:#ffb020; --bad:#ff4d4f;
      /* Sizing & radius */
      --r:12px; --gap:12px; --pad:16px; --shadow:0 10px 30px rgba(0,0,0,.3);
      /* Typography */
      --font-ui: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }
    html,body { height:100%; background:var(--bg-1); color:var(--fg-1); font:14px/1.5 var(--font-ui); margin:0; }
    a { color: var(--accent); text-decoration: none; }
    .visually-hidden { position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap; }
    /* Layout shell */
    #app { display:grid; grid-template-rows:auto 1fr auto; height:100vh; }
    .topbar, .bottombar { display:flex; align-items:center; gap:var(--gap); padding:var(--pad); background:var(--bg-2); box-shadow:var(--shadow); z-index:20; }
    .main { display:grid; grid-template-columns: 320px 1fr 380px; gap:var(--gap); padding:var(--gap); }
    .panel { background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.00)); border:1px solid rgba(255,255,255,.08); border-radius:var(--r); padding:var(--pad); }
    .chip { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; background:rgba(255,255,255,.06); border-radius:999px; }
    button { background:#14213d; color:var(--fg-0); border:1px solid rgba(255,255,255,.08); border-radius:10px; padding:10px 14px; cursor:pointer; }
    button.primary { background:var(--accent); color:#001018; font-weight:700; }
    button.ghost { background:transparent; border-color:rgba(255,255,255,.18); }
    /* Canvas + overlay stacking */
    .stage { position:relative; background:#04070f; border-radius:var(--r); overflow:hidden; }
    #gl { width:100%; height:100%; display:block; }
    .overlay { position:absolute; inset:0; pointer-events:none; }
    .legend { position:absolute; right:16px; top:16px; backdrop-filter: blur(8px); }
    .hud { position:absolute; left:16px; bottom:16px; }
    .tooltip { position: fixed; inset:auto auto 20px 20px; max-width:360px; }
    /* Step list */
    .steps li { list-style:none; margin:0 0 10px; padding:10px; border-radius:10px; background:rgba(255,255,255,.04); }
    .steps li.active { outline:2px solid var(--accent); background:rgba(0,209,255,.08); }
    /* Score card */
    .score-grid { display:grid; grid-template-columns:1fr auto; gap:8px; }
    progress { width:100%; height:8px; }
    /* High-contrast toggle hook */
    .high-contrast { filter: contrast(1.2) saturate(1.1); }
  </style>

  <!-- =========================
       SECTION 03: HEAD • EMBEDDED SVG ICON SPRITE
       ========================= -->
  <svg width="0" height="0" class="visually-hidden" aria-hidden="true">
    <symbol id="i-play" viewBox="0 0 24 24"><path fill="currentColor" d="M8 5v14l11-7z"/></symbol>
    <symbol id="i-pause" viewBox="0 0 24 24"><path fill="currentColor" d="M6 5h4v14H6zM14 5h4v14h-4z"/></symbol>
    <symbol id="i-hand" viewBox="0 0 24 24"><path fill="currentColor" d="M5 8l2-2 4 4 6-6 2 2-8 8z"/></symbol>
    <symbol id="i-warning" viewBox="0 0 24 24"><path fill="currentColor" d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2V9h2v5z"/></symbol>
    <symbol id="i-camera" viewBox="0 0 24 24"><path fill="currentColor" d="M4 7h4l2-2h4l2 2h4v12H4z"/></symbol>
    <!-- Add more as needed -->
  </svg>

  <!-- =========================
       SECTION 04: HEAD • AUDIO & HAPTICS PLACEHOLDERS
       ========================= -->
  <!-- Optional: base64 audio or blank sources to be filled later -->
  <audio id="snd-ok" preload="auto"></audio>
  <audio id="snd-warn" preload="auto"></audio>
  <audio id="snd-bad" preload="auto"></audio>
</head>

<body>
  <!-- =========================
       SECTION 05: APP SHELL & ACCESSIBILITY LANDMARKS
       ========================= -->
  <a class="visually-hidden" href="#main">Skip to main content</a>
  <div id="app" class="" role="application" aria-label="Mitral Valve Simulator">

    <!-- =========================
         SECTION 06: UI • TOP BAR / MODE SWITCH
         ========================= -->
    <header class="topbar" aria-label="Top bar">
      <div class="chip" aria-label="App title">MitralSim <small>v0.1</small></div>
      <div class="chip">Scenario:
        <select id="scenario">
          <option value="suturing-basic">Posterior leaflet interrupted suturing</option>
          <option value="ring-annuloplasty">Ring annuloplasty (sim)</option>
          <option value="replacement">MV replacement (sim)</option>
        </select>
      </div>
      <div class="chip">Mode:
        <select id="mode">
          <option value="training">Training</option>
          <option value="practice">Practice</option>
          <option value="assessment">Assessment</option>
        </select>
      </div>
      <div style="margin-left:auto; display:flex; gap:8px;">
        <label class="chip"><input id="toggle-contrast" type="checkbox" /> High contrast</label>
        <button id="open-onboarding" class="ghost">Help</button>
        <button id="take-screenshot" title="Save snapshot"><svg width="18" height="18"><use href="#i-camera"/></svg></button>
      </div>
    </header>

    <main id="main" class="main" aria-label="Main workspace">
      <!-- =========================
           SECTION 07: UI • LEFT RAIL — INSTRUMENTS & TOOLS
           ========================= -->
      <aside class="panel" aria-label="Instruments">
        <h3>Instruments</h3>
        <ul id="tools">
          <li><label><input type="radio" name="tool" value="needle-driver" checked> Needle driver</label></li>
          <li><label><input type="radio" name="tool" value="forceps"> Forceps</label></li>
          <li><label><input type="radio" name="tool" value="scissors"> Scissors</label></li>
          <li><label><input type="radio" name="tool" value="suction"> Suction</label></li>
          <li><label><input type="radio" name="tool" value="ring-sizer"> Ring sizer</label></li>
        </ul>
        <hr/>
        <h4>Instrument Telemetry</h4>
        <div class="score-grid">
          <span>Tip force</span><span id="tele-force" style="text-align:right">0.0 N</span>
          <span>Grip angle</span><span id="tele-angle" style="text-align:right">0°</span>
          <span>Collision</span><span id="tele-coll" style="text-align:right">None</span>
        </div>
      </aside>

      <!-- =========================
           SECTION 08: UI • CENTER STAGE — SIMULATION CANVAS
           ========================= -->
      <section class="stage panel" aria-label="Simulation Stage">
        <canvas id="gl" aria-label="3D mitral valve scene"></canvas>
        <svg id="overlay" class="overlay" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <!-- dynamic annotations/hotspots/rulers rendered here -->
        </svg>
        <!-- Floating legend & HUD -->
        <div class="legend panel">
          <h4>Legend</h4>
          <ul style="margin:0; padding-left:18px;">
            <li><span style="color:var(--accent)">Cyan</span> = Target bite zone</li>
            <li><span style="color:var(--ok)">Green</span> = Valid stitch</li>
            <li><span style="color:var(--warn)">Amber</span> = Shallow/steep angle</li>
            <li><span style="color:var(--bad)">Red</span> = Chordal injury risk</li>
          </ul>
        </div>
        <div class="hud panel">
          <div>Step <b id="step-idx">1</b>/<span id="step-total">—</span> • <span id="step-title">—</span></div>
          <div>Timer: <span id="timer">00:00</span></div>
        </div>
        <div id="tooltip" class="tooltip panel" role="status" aria-live="polite">Welcome. Press <b>?</b> for help.</div>
      </section>

      <!-- =========================
           SECTION 10: UI • RIGHT RAIL — AI CO-PILOT
           ========================= -->
      <aside class="panel" aria-label="AI Co‑Pilot">
        <h3>AI Co‑Pilot</h3>
        <p id="copilot-summary">Follow the highlighted path for your first posterior leaflet stitch.</p>
        <ol id="step-list" class="steps">
          <!-- li items injected per step -->
        </ol>
        <hr/>
        <h4>Feedback</h4>
        <div id="feedback">
          <p>Errors & suggestions will appear here.</p>
        </div>
      </aside>
    </main>

    <!-- =========================
         SECTION 11: UI • BOTTOM BAR — TRANSPORT & SESSION CONTROLS
         ========================= -->
    <footer class="bottombar" aria-label="Controls">
      <div style="display:flex; gap:8px;">
        <button id="btn-start" class="primary"><svg width="18" height="18"><use href="#i-play"/></svg> Start</button>
        <button id="btn-pause"><svg width="18" height="18"><use href="#i-pause"/></svg> Pause</button>
        <button id="btn-reset" class="ghost">Reset</button>
        <button id="btn-undo" class="ghost">Undo</button>
        <button id="btn-redo" class="ghost">Redo</button>
      </div>
      <div style="margin-left:auto; display:flex; gap:12px; align-items:center;">
        <div class="chip">Score: <b id="score">0</b></div>
        <div class="chip">Safety: <b id="score-safety">100%</b></div>
        <div class="chip">Accuracy: <b id="score-accuracy">0%</b></div>
        <div class="chip">Efficiency: <b id="score-efficiency">—</b></div>
      </div>
    </footer>
  </div>

  <!-- =========================
       SECTION 12: UI • DIALOGS & SHEETS
       ========================= -->
  <dialog id="dlg-onboarding" class="panel">
    <h3>Welcome</h3>
    <p>This simulator guides you through mitral valve suturing with stepwise highlights and scoring.</p>
    <ul>
      <li><b>Training</b>: step‑by‑step with enforced sequence.</li>
      <li><b>Practice</b>: guided but flexible sequence.</li>
      <li><b>Assessment</b>: silent mode; full scoring.</li>
    </ul>
    <button id="ob-ok" class="primary">Let’s begin</button>
  </dialog>

  <!-- =========================
       SECTION 13–28: SCRIPTS (MODULE)
       ========================= -->
  <script type="module">
  // =========================
  // SECTION 13: BOOT & CAPABILITY CHECKS
  // =========================
  const caps = {
    webgl2: !!document.createElement('canvas').getContext('webgl2'),
    reducedMotion: window.matchMedia('(prefers-reduced-motion: reduce)').matches
  };
  if (!caps.webgl2) {
    document.body.innerHTML = '<div style="padding:24px;color:white;font:16px/1.5 var(--font-ui)">'+
      '<h2>WebGL2 not available</h2><p>This simulator needs a modern browser/GPU. Try Chrome/Edge/Firefox on desktop.</p></div>';
    throw new Error('WebGL2 required');
  }

  // =========================
  // SECTION 14: STATE STORE & EVENT BUS
  // =========================
  const State = {
    mode: 'training',
    scenario: 'suturing-basic',
    stepIndex: 0,
    timerStart: 0,
    score: { total:0, safety:100, accuracy:0, efficiency:null },
    telemetry: { forceN:0, angleDeg:0, collisions:0 },
    flags: { highContrast:false },
  };
  const Bus = new EventTarget();
  const emit = (type, detail) => Bus.dispatchEvent(new CustomEvent(type, { detail }));

  // =========================
  // SECTION 15: GEOMETRY & ASSETS BUILDER (PARAMETRIC)
  // =========================
  // Placeholder stubs; you will fill with mesh generation later.
  const Assets = {};
  function buildMitralApparatus(params={}) {
    // TODO: annulus spline, leaflets (A/P segments), chordae trees, papillary anchors
    return { meshes:{}, bounds:{}, landmarks:{} };
  }

  // =========================
  // SECTION 16: RENDERER & MATERIALS
  // =========================
  let gl, renderer;
  function initRenderer() {
    const canvas = document.getElementById('gl');
    gl = canvas.getContext('webgl2', { antialias:true, alpha:false });
    // TODO: init program(s), FBOs, simple SSS / wetness shading
    onResize();
    window.addEventListener('resize', onResize);
  }
  function onResize(){
    const c = gl.canvas; const dpr = Math.min(window.devicePixelRatio||1, 2);
    c.width = c.clientWidth * dpr; c.height = c.clientHeight * dpr;
    // TODO: viewport update
  }
  function renderFrame(t){
    // TODO: draw valve, instruments, suture thread, overlays
    requestAnimationFrame(renderFrame);
  }

  // =========================
  // SECTION 17: CAMERA & INTERACTION
  // =========================
  const Input = { pointer:{down:false,x:0,y:0}, tool:'needle-driver' };
  function bindInteraction(){
    const canvas = document.getElementById('gl');
    canvas.addEventListener('pointerdown', e => { Input.pointer.down=true; });
    canvas.addEventListener('pointerup',   e => { Input.pointer.down=false; });
    canvas.addEventListener('pointermove', e => { Input.pointer.x=e.offsetX; Input.pointer.y=e.offsetY; });
    document.querySelector('#tools').addEventListener('change', e=>{
      if (e.target.name==='tool') Input.tool = e.target.value;
    });
  }

  // =========================
  // SECTION 18: PHYSICS LITE (SURFACE + THREAD)
  // =========================
  const Physics = {
    // TODO: mass-spring for leaflets; constraint chain for suture
  };

  // =========================
  // SECTION 19: SUTURING ENGINE
  // =========================
  const Suturing = {
    stitches: [],
    takeBite(worldPt, normal, options){
      // TODO: log & validate bite depth/spacing/angle; update scoring hooks
    },
    evaluateQuality(){ /* TODO */ },
  };

  // =========================
  // SECTION 20: SCENARIO & STEP MACHINE (Training/Practice)
  // =========================
  const Scenarios = {
    "suturing-basic": {
      title: "Posterior leaflet interrupted suturing",
      steps: [
        { id:"prep-01", title:"Identify target coaptation zone",
          highlight:{ region:"P2", type:"fill" },
          goal:{ gaze:true, duration:2000 },
          rubric:{ weight:0.05 } },
        { id:"mark-01", title:"Mark first annular anchor (P2 midpoint)",
          highlight:{ region:"annulus-P2", type:"ring" },
          goal:{ clickWithinMm:2 },
          rubric:{ weight:0.10, accuracyMm:[0,1,2,4] } },
        { id:"bite-01", title:"Needle bite: ventricular→atrial at P2",
          highlight:{ region:"leaflet-P2", type:"zone" },
          goal:{ biteDepthMm:[1.5,3.0], angleDeg:[35,55], spacingMm:[2.0,3.0] },
          rubric:{ weight:0.25, safetyPenaltyChordInjury:0.3 } },
        // ...more steps: symmetric bites, knot tying, saline test, etc.
      ]
    }
  };

  // =========================
  // SECTION 21: AI CO-PILOT LOGIC (Hints, Errors, Remediation)
  // =========================
  function setMode(v){ State.mode=v; emit('mode', v); }
  function gotoStep(i){
    State.stepIndex = Math.max(0, Math.min(i, getSteps().length-1));
    updateStepUI();
    focusCameraToCurrentStep();
    speak(`Step ${State.stepIndex+1}. ${getSteps()[State.stepIndex].title}`);
  }
  function getSteps(){ return Scenarios[State.scenario].steps; }
  function analyzeAndGuide(event){
    // TODO: inspect last action; classify (angle shallow, bite too deep, near chordae, spacing off)
    // then: highlight error region, suggest correction, adjust target tolerances if practice mode
  }

  // =========================
  // SECTION 22: SCORING & RUBRIC
  // =========================
  const Scoring = {
    weights:{ accuracy:0.5, safety:0.3, efficiency:0.2 },
    metrics:{ accuracy:0, safety:1.0, efficiency:0 },
    compute(){
      const total = (this.metrics.accuracy*this.weights.accuracy) +
                    (this.metrics.safety  *this.weights.safety)   +
                    (this.metrics.efficiency*this.weights.efficiency);
      State.score.total = Math.round(total*100);
      updateScoreUI();
    }
  };

  // =========================
  // SECTION 23: OVERLAY & ANNOTATION RENDERER (SVG)
  // =========================
  function drawHighlight(opts){ /* TODO: add <circle>/<path> to #overlay; animate pulse */ }
  function drawRuler(a,b,mm){ /* TODO: measurement line with mm labels */ }

  // =========================
  // SECTION 24: AUDIO/VOICE & TEXT-TO-CUE
  // =========================
  function speak(text){
    // Optional: use SpeechSynthesis if available; always show text in tooltip for accessibility
    document.getElementById('tooltip').textContent = text;
    if ('speechSynthesis' in window) { window.speechSynthesis.cancel(); window.speechSynthesis.speak(new SpeechSynthesisUtterance(text)); }
  }

  // =========================
  // SECTION 25: PERSISTENCE & EXPORT
  // =========================
  function saveSession(){
    const payload = { State, Suturing };
    localStorage.setItem('mitralsim-session', JSON.stringify(payload));
  }
  function exportSnapshot(){
    // TODO: draw overlay into offscreen canvas + gl canvas, export PNG; also export JSON of attempts
  }

  // =========================
  // SECTION 26: ACCESSIBILITY & LOCALIZATION
  // =========================
  const STR = { en: { start:"Start", pause:"Pause" } }; // placeholder

  // =========================
  // SECTION 27: DEBUG & QA PANEL
  // =========================
  const Debug = { enabled:false };

  // =========================
  // SECTION 28: INIT & SAFE FALLBACK
  // =========================
  function updateScoreUI(){
    document.getElementById('score').textContent = State.score.total;
    document.getElementById('score-safety').textContent = Math.round(Scoring.metrics.safety*100)+'%';
    document.getElementById('score-accuracy').textContent = Math.round(Scoring.metrics.accuracy*100)+'%';
  }
  function updateStepUI(){
    document.getElementById('step-idx').textContent = State.stepIndex+1;
    document.getElementById('step-total').textContent = getSteps().length;
    document.getElementById('step-title').textContent = getSteps()[State.stepIndex].title;
    // Populate right-rail steps
    const ol = document.getElementById('step-list'); ol.innerHTML='';
    getSteps().forEach((s,idx)=>{
      const li = document.createElement('li'); li.textContent = s.title; if (idx===State.stepIndex) li.classList.add('active'); ol.appendChild(li);
    });
  }

  // Wire UI
  document.getElementById('mode').addEventListener('change', e=>setMode(e.target.value));
  document.getElementById('scenario').addEventListener('change', e=>{ State.scenario=e.target.value; gotoStep(0); });
  document.getElementById('btn-start').addEventListener('click', ()=>{ State.timerStart=performance.now(); speak('Session started'); });
  document.getElementById('btn-reset').addEventListener('click', ()=>{ location.reload(); });
  document.getElementById('toggle-contrast').addEventListener('change', e=>{ document.getElementById('app').classList.toggle('high-contrast', e.target.checked); });
  document.getElementById('take-screenshot').addEventListener('click', exportSnapshot);
  document.getElementById('open-onboarding').addEventListener('click', ()=>document.getElementById('dlg-onboarding').showModal());
  document.getElementById('ob-ok').addEventListener('click', ()=>document.getElementById('dlg-onboarding').close());

  // Start
  initRenderer(); bindInteraction();
  gotoStep(0); updateScoreUI();
  requestAnimationFrame(renderFrame);
  </script>
</body>
</html>
