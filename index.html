<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CardioVis Sim - Advanced Cardiac Surgery Training Platform</title>
    
    <!-- Three.js and Required Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/r17/Stats.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simplex-noise/2.4.0/simplex-noise.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --dark-bg: #0a0e27;
            --card-bg: rgba(17, 25, 40, 0.75);
            --border-color: rgba(255, 255, 255, 0.125);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --accent-blue: #00d4ff;
            --accent-purple: #a855f7;
            --accent-pink: #ec4899;
            --success-green: #10b981;
            --warning-yellow: #f59e0b;
            --danger-red: #ef4444;
        }

        body {
            background: var(--dark-bg);
            color: var(--text-primary);
            overflow: hidden;
            position: relative;
            font-size: 14px;
        }

        /* Loading Screen with DNA Animation */
        .loading-screen {
            position: fixed;
            inset: 0;
            background: radial-gradient(ellipse at center, #0a0e27 0%, #000000 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 1s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .dna-loader {
            width: 200px;
            height: 200px;
            position: relative;
            animation: rotate 4s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .dna-strand {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .dna-helix {
            position: absolute;
            width: 4px;
            height: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(180deg, 
                #00d4ff 0%, 
                #a855f7 25%, 
                #ec4899 50%, 
                #a855f7 75%, 
                #00d4ff 100%);
            animation: wave 2s ease-in-out infinite;
        }

        @keyframes wave {
            0%, 100% { transform: translateX(-50%) scaleY(1); }
            50% { transform: translateX(-50%) scaleY(0.8); }
        }

        .loading-text {
            margin-top: 40px;
            font-size: 20px;
            font-weight: 300;
            letter-spacing: 4px;
            text-transform: uppercase;
            background: linear-gradient(90deg, #00d4ff, #a855f7, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shimmer 2s linear infinite;
        }

        @keyframes shimmer {
            0% { filter: brightness(1); }
            50% { filter: brightness(1.3); }
            100% { filter: brightness(1); }
        }

        .loading-subtitle {
            margin-top: 10px;
            font-size: 12px;
            color: var(--text-secondary);
            letter-spacing: 2px;
        }

        .loading-progress {
            width: 300px;
            height: 3px;
            background: rgba(255, 255, 255, 0.1);
            margin-top: 30px;
            border-radius: 3px;
            overflow: hidden;
        }

        .loading-bar {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #a855f7, #ec4899);
            animation: loadProgress 4s ease-out forwards;
        }

        @keyframes loadProgress {
            from { width: 0%; }
            to { width: 100%; }
        }

        /* Main Container */
        #mainContainer {
            width: 100vw;
            height: 100vh;
            position: relative;
            background: linear-gradient(180deg, #0a0e27 0%, #1a1d3e 50%, #0a0e27 100%);
        }

        #canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* UI Overlay System */
        .ui-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 100;
        }

        /* Advanced Header */
        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 90px;
            background: linear-gradient(180deg, rgba(10,14,39,0.98) 0%, rgba(10,14,39,0) 100%);
            backdrop-filter: blur(20px) saturate(150%);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 40px;
            pointer-events: auto;
        }

        .brand-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .brand-logo {
            width: 60px;
            height: 60px;
            background: var(--primary-gradient);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 24px;
            box-shadow: 0 8px 32px rgba(102,126,234,0.4);
            position: relative;
            overflow: hidden;
        }

        .brand-logo::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: logoShine 3s infinite;
        }

        @keyframes logoShine {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .brand-info h1 {
            font-size: 28px;
            font-weight: 600;
            background: linear-gradient(135deg, #00d4ff, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
            letter-spacing: 1px;
        }

        .brand-subtitle {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-top: 4px;
        }

        .version-badge {
            background: rgba(168,85,247,0.2);
            border: 1px solid var(--accent-purple);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 10px;
            color: var(--accent-purple);
            margin-left: 15px;
        }

        /* Real-time Metrics Dashboard */
        .metrics-dashboard {
            display: flex;
            gap: 30px;
            align-items: center;
            pointer-events: auto;
        }

        .metric-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px 20px;
            backdrop-filter: blur(10px);
            min-width: 120px;
        }

        .metric-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 600;
            font-family: 'SF Mono', 'Monaco', monospace;
            display: flex;
            align-items: baseline;
            gap: 5px;
        }

        .metric-value.pulse {
            color: #ef4444;
            text-shadow: 0 0 20px rgba(239,68,68,0.5);
            animation: heartPulse 1s ease-in-out infinite;
        }

        @keyframes heartPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .metric-value.pressure {
            color: #10b981;
            text-shadow: 0 0 20px rgba(16,185,129,0.5);
        }

        .metric-value.oxygen {
            color: #00d4ff;
            text-shadow: 0 0 20px rgba(0,212,255,0.5);
        }

        .metric-value.flow {
            color: #f59e0b;
            text-shadow: 0 0 20px rgba(245,158,11,0.5);
        }

        .metric-unit {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .metric-graph {
            margin-top: 8px;
            height: 30px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .graph-line {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 100%;
            background: linear-gradient(180deg, currentColor, transparent);
            opacity: 0.3;
        }

        /* Navigation Panel */
        .nav-panel {
            position: absolute;
            left: 0;
            top: 90px;
            bottom: 0;
            width: 380px;
            background: linear-gradient(180deg, rgba(17,25,40,0.98) 0%, rgba(10,14,39,0.98) 100%);
            backdrop-filter: blur(20px) saturate(150%);
            border-right: 1px solid var(--border-color);
            overflow: hidden;
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-panel.collapsed {
            transform: translateX(-340px);
        }

        .panel-toggle {
            position: absolute;
            right: -25px;
            top: 20px;
            width: 50px;
            height: 50px;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 10;
        }

        .panel-toggle:hover {
            background: rgba(168,85,247,0.2);
            border-color: var(--accent-purple);
            transform: scale(1.1);
        }

        /* Tab System */
        .nav-tabs {
            display: flex;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid var(--border-color);
        }

        .nav-tab {
            flex: 1;
            padding: 18px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .nav-tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-gradient);
            transform: scaleX(0);
            transition: transform 0.3s;
        }

        .nav-tab:hover {
            color: var(--text-primary);
            background: rgba(255,255,255,0.02);
        }

        .nav-tab.active {
            color: var(--accent-blue);
        }

        .nav-tab.active::after {
            transform: scaleX(1);
        }

        /* Anatomy List with Categories */
        .anatomy-explorer {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 14px 20px 14px 50px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: all 0.3s;
        }

        .search-input:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(0,212,255,0.1);
            background: rgba(0,0,0,0.5);
        }

        .search-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .anatomy-categories {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .category-section {
            background: rgba(0,0,0,0.2);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        .category-section.expanded {
            border-color: var(--accent-purple);
            box-shadow: 0 8px 32px rgba(168,85,247,0.1);
        }

        .category-header {
            padding: 18px 20px;
            background: linear-gradient(135deg, rgba(168,85,247,0.1), rgba(236,72,153,0.1));
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s;
        }

        .category-header:hover {
            background: linear-gradient(135deg, rgba(168,85,247,0.15), rgba(236,72,153,0.15));
        }

        .category-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .category-icon {
            width: 40px;
            height: 40px;
            background: var(--primary-gradient);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .category-details {
            flex: 1;
        }

        .category-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 3px;
        }

        .category-count {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .category-arrow {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s;
        }

        .category-section.expanded .category-arrow {
            transform: rotate(180deg);
        }

        .category-items {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .category-section.expanded .category-items {
            max-height: 600px;
        }

        .structure-item {
            padding: 16px 20px;
            border-top: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
        }

        .structure-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--primary-gradient);
            transform: scaleX(0);
            transition: transform 0.3s;
        }

        .structure-item:hover {
            background: rgba(168,85,247,0.05);
            padding-left: 25px;
        }

        .structure-item:hover::before {
            transform: scaleX(1);
        }

        .structure-item.active {
            background: rgba(168,85,247,0.1);
            border-left: 4px solid var(--accent-purple);
        }

        .structure-indicator {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: currentColor;
            opacity: 0.2;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .structure-indicator::after {
            content: attr(data-abbr);
            position: absolute;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .structure-pulse {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 8px;
            height: 8px;
            background: currentColor;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.5); }
            100% { opacity: 0; transform: scale(2); }
        }

        .structure-info {
            flex: 1;
        }

        .structure-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .structure-details {
            font-size: 11px;
            color: var(--text-secondary);
            display: flex;
            gap: 10px;
        }

        .structure-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Information Panel */
        .info-panel {
            position: absolute;
            right: 0;
            top: 90px;
            bottom: 0;
            width: 450px;
            background: linear-gradient(180deg, rgba(17,25,40,0.98) 0%, rgba(10,14,39,0.98) 100%);
            backdrop-filter: blur(20px) saturate(150%);
            border-left: 1px solid var(--border-color);
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .info-panel.collapsed {
            transform: translateX(410px);
        }

        .info-header {
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid var(--border-color);
        }

        .info-title {
            font-size: 18px;
            font-weight: 600;
            background: linear-gradient(135deg, #00d4ff, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }

        .info-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .info-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .info-section {
            margin-bottom: 30px;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .section-icon {
            width: 32px;
            height: 32px;
            background: var(--primary-gradient);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-primary);
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .data-card {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s;
        }

        .data-card:hover {
            background: rgba(168,85,247,0.05);
            border-color: var(--accent-purple);
            transform: translateY(-2px);
        }

        .data-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .data-value {
            font-size: 20px;
            font-weight: 600;
            color: var(--accent-blue);
            display: flex;
            align-items: baseline;
            gap: 5px;
        }

        .data-unit {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .data-trend {
            margin-top: 5px;
            font-size: 11px;
            color: var(--success-green);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .data-trend.down {
            color: var(--danger-red);
        }

        /* Control Dock */
        .control-dock {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            backdrop-filter: blur(20px) saturate(150%);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 20px 30px;
            display: flex;
            gap: 30px;
            align-items: center;
            pointer-events: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .control-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .control-separator {
            width: 1px;
            height: 40px;
            background: var(--border-color);
        }

        .control-btn {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .control-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: var(--primary-gradient);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .control-btn:hover {
            transform: translateY(-4px);
            border-color: var(--accent-purple);
            color: var(--text-primary);
            box-shadow: 0 10px 30px rgba(168,85,247,0.3);
        }

        .control-btn:hover::before {
            opacity: 0.1;
        }

        .control-btn.active {
            background: rgba(168,85,247,0.2);
            border-color: var(--accent-purple);
            color: var(--accent-purple);
        }

        .control-btn.active::before {
            opacity: 0.3;
        }

        .control-icon {
            font-size: 20px;
            position: relative;
            z-index: 1;
        }

        .control-label {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            z-index: 1;
        }

        /* Mode Switcher */
        .mode-switcher {
            display: flex;
            background: rgba(0,0,0,0.5);
            border-radius: 12px;
            padding: 4px;
            gap: 4px;
        }

        .mode-btn {
            padding: 12px 20px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
            position: relative;
        }

        .mode-btn:hover {
            color: var(--text-primary);
        }

        .mode-btn.active {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 12px rgba(168,85,247,0.4);
        }

        /* Learning Interface */
        .learning-interface {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(20px);
            display: none;
            z-index: 1000;
            pointer-events: auto;
        }

        .learning-interface.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .learning-container {
            width: 90%;
            max-width: 1200px;
            height: 90%;
            background: linear-gradient(135deg, rgba(17,25,40,0.98) 0%, rgba(10,14,39,0.98) 100%);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            display: flex;
            overflow: hidden;
            box-shadow: 0 30px 90px rgba(0,0,0,0.8);
        }

        .learning-sidebar {
            width: 300px;
            background: rgba(0,0,0,0.3);
            border-right: 1px solid var(--border-color);
            padding: 30px 20px;
            overflow-y: auto;
        }

        .learning-progress {
            margin-bottom: 30px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .progress-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
        }

        .progress-percentage {
            font-size: 18px;
            font-weight: 600;
            color: var(--accent-blue);
        }

        .progress-bar {
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-gradient);
            border-radius: 4px;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: progressShine 2s linear infinite;
        }

        @keyframes progressShine {
            from { transform: translateX(-100%); }
            to { transform: translateX(100%); }
        }

        .learning-modules {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .module-item {
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .module-item:hover {
            background: rgba(168,85,247,0.05);
            border-color: var(--accent-purple);
            transform: translateX(5px);
        }

        .module-item.completed {
            border-color: var(--success-green);
        }

        .module-item.active {
            background: rgba(168,85,247,0.1);
            border-color: var(--accent-purple);
            box-shadow: 0 4px 12px rgba(168,85,247,0.2);
        }

        .module-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }

        .module-info {
            flex: 1;
        }

        .module-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 3px;
        }

        .module-duration {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .module-status {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .module-item.completed .module-status {
            background: var(--success-green);
            border-color: var(--success-green);
        }

        .learning-content {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .lesson-header {
            margin-bottom: 30px;
        }

        .lesson-title {
            font-size: 32px;
            font-weight: 300;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #00d4ff, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .lesson-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .lesson-body {
            flex: 1;
            margin-bottom: 30px;
        }

        .lesson-section {
            margin-bottom: 30px;
        }

        .lesson-section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .lesson-section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: var(--primary-gradient);
            border-radius: 2px;
        }

        .lesson-paragraph {
            font-size: 15px;
            line-height: 1.8;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .lesson-highlight {
            color: var(--accent-blue);
            font-weight: 500;
            background: rgba(0,212,255,0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .lesson-important {
            padding: 20px;
            background: rgba(168,85,247,0.1);
            border-left: 4px solid var(--accent-purple);
            border-radius: 8px;
            margin: 20px 0;
        }

        .lesson-important-title {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent-purple);
            margin-bottom: 10px;
        }

        .lesson-list {
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }

        .lesson-list li {
            padding-left: 30px;
            position: relative;
            margin-bottom: 12px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .lesson-list li::before {
            content: '▸';
            position: absolute;
            left: 0;
            color: var(--accent-purple);
            font-size: 18px;
        }

        .lesson-visual {
            margin: 30px 0;
            padding: 30px;
            background: rgba(0,0,0,0.3);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .lesson-diagram {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            border-radius: 12px;
        }

        .lesson-caption {
            margin-top: 15px;
            font-size: 13px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .lesson-actions {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            padding-top: 30px;
            border-top: 1px solid var(--border-color);
        }

        .lesson-btn {
            padding: 15px 30px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .lesson-btn:hover {
            background: rgba(168,85,247,0.1);
            border-color: var(--accent-purple);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(168,85,247,0.2);
        }

        .lesson-btn.primary {
            background: var(--primary-gradient);
            border: none;
            color: white;
        }

        .lesson-btn.primary:hover {
            box-shadow: 0 10px 30px rgba(168,85,247,0.4);
        }

        /* Assessment System */
        .assessment-interface {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(20px);
            display: none;
            z-index: 1000;
            pointer-events: auto;
        }

        .assessment-interface.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .assessment-container {
            width: 90%;
            max-width: 1000px;
            background: linear-gradient(135deg, rgba(17,25,40,0.98) 0%, rgba(10,14,39,0.98) 100%);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 30px 90px rgba(0,0,0,0.8);
        }

        .quiz-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .quiz-title {
            font-size: 32px;
            font-weight: 300;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #00d4ff, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .quiz-progress-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
        }

        .quiz-stat {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quiz-stat-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
        }

        .quiz-stat-value {
            font-size: 20px;
            font-weight: 600;
            color: var(--accent-blue);
        }

        .quiz-progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .quiz-progress-fill {
            height: 100%;
            background: var(--primary-gradient);
            transition: width 0.5s ease;
        }

        .quiz-question-container {
            margin-bottom: 40px;
        }

        .quiz-question {
            font-size: 24px;
            font-weight: 300;
            line-height: 1.6;
            margin-bottom: 30px;
            color: var(--text-primary);
        }

        .quiz-visual {
            margin-bottom: 30px;
            text-align: center;
        }

        .quiz-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .quiz-options {
            display: grid;
            gap: 15px;
        }

        .quiz-option {
            padding: 20px 25px;
            background: rgba(0,0,0,0.3);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .quiz-option:hover {
            background: rgba(168,85,247,0.05);
            border-color: var(--accent-purple);
            transform: translateX(5px);
        }

        .quiz-option.selected {
            background: rgba(168,85,247,0.1);
            border-color: var(--accent-purple);
        }

        .quiz-option.correct {
            background: rgba(16,185,129,0.1);
            border-color: var(--success-green);
            animation: correctAnimation 0.5s ease;
        }

        @keyframes correctAnimation {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .quiz-option.incorrect {
            background: rgba(239,68,68,0.1);
            border-color: var(--danger-red);
            animation: incorrectAnimation 0.5s ease;
        }

        @keyframes incorrectAnimation {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .option-indicator {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: rgba(255,255,255,0.05);
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 18px;
            transition: all 0.3s;
        }

        .quiz-option.selected .option-indicator {
            background: var(--primary-gradient);
            border: none;
            color: white;
        }

        .quiz-option.correct .option-indicator {
            background: var(--success-green);
            border: none;
            color: white;
        }

        .quiz-option.incorrect .option-indicator {
            background: var(--danger-red);
            border: none;
            color: white;
        }

        .option-content {
            flex: 1;
        }

        .option-text {
            font-size: 16px;
            line-height: 1.5;
            color: var(--text-primary);
        }

        .quiz-explanation {
            margin-top: 30px;
            padding: 25px;
            background: rgba(0,0,0,0.3);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            display: none;
        }

        .quiz-explanation.show {
            display: block;
            animation: fadeInUp 0.5s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .explanation-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .explanation-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .explanation-icon.correct {
            background: var(--success-green);
        }

        .explanation-icon.incorrect {
            background: var(--danger-red);
        }

        .explanation-title {
            font-size: 18px;
            font-weight: 600;
        }

        .explanation-text {
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .quiz-actions {
            margin-top: 40px;
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }

        /* Tooltip System */
        .tooltip {
            position: absolute;
            background: linear-gradient(135deg, rgba(17,25,40,0.98) 0%, rgba(10,14,39,0.98) 100%);
            backdrop-filter: blur(20px);
            padding: 15px 20px;
            border-radius: 12px;
            border: 1px solid var(--accent-purple);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10000;
            max-width: 300px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .tooltip.visible {
            opacity: 1;
        }

        .tooltip-header {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-blue);
            margin-bottom: 8px;
        }

        .tooltip-body {
            font-size: 12px;
            line-height: 1.5;
            color: var(--text-secondary);
        }

        /* Notification System */
        .notification {
            position: fixed;
            top: 110px;
            right: -400px;
            width: 360px;
            background: linear-gradient(135deg, rgba(17,25,40,0.98) 0%, rgba(10,14,39,0.98) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            transition: right 0.3s ease;
            z-index: 10000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .notification.show {
            right: 20px;
        }

        .notification-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .notification-icon.success {
            background: rgba(16,185,129,0.2);
            color: var(--success-green);
        }

        .notification-icon.info {
            background: rgba(0,212,255,0.2);
            color: var(--accent-blue);
        }

        .notification-icon.warning {
            background: rgba(245,158,11,0.2);
            color: var(--warning-yellow);
        }

        .notification-icon.error {
            background: rgba(239,68,68,0.2);
            color: var(--danger-red);
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .notification-message {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .notification-close {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 24px;
            height: 24px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .notification-close:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }

        /* ECG Monitor */
        .ecg-monitor {
            position: absolute;
            bottom: 110px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 60px;
            background: rgba(0,0,0,0.5);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            pointer-events: none;
        }

        .ecg-trace {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0.8;
        }

        .ecg-line {
            stroke: #00ff00;
            stroke-width: 2;
            fill: none;
            filter: drop-shadow(0 0 5px #00ff00);
        }

        .ecg-grid {
            stroke: rgba(0,255,0,0.1);
            stroke-width: 0.5;
        }

        /* Responsive */
        @media (max-width: 1600px) {
            .nav-panel { width: 340px; }
            .info-panel { width: 400px; }
        }

        @media (max-width: 1400px) {
            .nav-panel { width: 300px; }
            .info-panel { width: 360px; }
            .control-dock { 
                padding: 15px 20px;
                gap: 20px;
            }
            .control-btn {
                width: 48px;
                height: 48px;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.3);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--accent-purple), var(--accent-pink));
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--accent-pink), var(--accent-purple));
        }

        /* Animations */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(168,85,247,0.5); }
            50% { box-shadow: 0 0 40px rgba(168,85,247,0.8); }
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="dna-loader">
            <div class="dna-strand">
                <div class="dna-helix"></div>
            </div>
        </div>
        <div class="loading-text">CardioVis Sim</div>
        <div class="loading-subtitle">Initializing Photorealistic Cardiac Models...</div>
        <div class="loading-progress">
            <div class="loading-bar"></div>
        </div>
    </div>

    <!-- Main Container -->
    <div id="mainContainer">
        <!-- 3D Canvas -->
        <canvas id="canvas"></canvas>

        <!-- UI Overlay -->
        <div class="ui-overlay">
            <!-- Header -->
            <div class="header">
                <div class="brand-section">
                    <div class="brand-logo">CVS</div>
                    <div class="brand-info">
                        <h1>CardioVis Sim</h1>
                        <div class="brand-subtitle">Professional Cardiac Surgery Training Platform</div>
                    </div>
                    <div class="version-badge">v3.0 Pro</div>
                </div>
                <div class="metrics-dashboard">
                    <div class="metric-card">
                        <div class="metric-label">Heart Rate</div>
                        <div class="metric-value pulse">
                            <span id="heartRate">72</span>
                            <span class="metric-unit">bpm</span>
                        </div>
                        <div class="metric-graph">
                            <div class="graph-line"></div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Blood Pressure</div>
                        <div class="metric-value pressure">
                            <span id="bloodPressure">120/80</span>
                            <span class="metric-unit">mmHg</span>
                        </div>
                        <div class="metric-graph">
                            <div class="graph-line"></div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">SpO₂</div>
                        <div class="metric-value oxygen">
                            <span id="oxygenSat">98</span>
                            <span class="metric-unit">%</span>
                        </div>
                        <div class="metric-graph">
                            <div class="graph-line"></div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Cardiac Output</div>
                        <div class="metric-value flow">
                            <span id="cardiacOutput">5.2</span>
                            <span class="metric-unit">L/min</span>
                        </div>
                        <div class="metric-graph">
                            <div class="graph-line"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Panel -->
            <div class="nav-panel" id="navPanel">
                <div class="panel-toggle" onclick="togglePanel('nav')">
                    <span id="navToggleIcon">◀</span>
                </div>
                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="switchNavTab('anatomy')">Anatomy</button>
                    <button class="nav-tab" onclick="switchNavTab('pathology')">Pathology</button>
                    <button class="nav-tab" onclick="switchNavTab('procedures')">Procedures</button>
                </div>
                <div class="anatomy-explorer" id="anatomyExplorer">
                    <div class="search-container">
                        <span class="search-icon">🔍</span>
                        <input type="text" class="search-input" placeholder="Search anatomical structures..." id="anatomySearch">
                    </div>
                    <div class="anatomy-categories">
                        <!-- Cardiac Chambers -->
                        <div class="category-section expanded" id="cat-chambers">
                            <div class="category-header" onclick="toggleCategory('chambers')">
                                <div class="category-info">
                                    <div class="category-icon">🫀</div>
                                    <div class="category-details">
                                        <div class="category-name">Cardiac Chambers</div>
                                        <div class="category-count">4 structures</div>
                                    </div>
                                </div>
                                <div class="category-arrow">▼</div>
                            </div>
                            <div class="category-items">
                                <div class="structure-item" data-structure="left-atrium" style="color: #ff6b6b;">
                                    <div class="structure-indicator" data-abbr="LA">
                                        <div class="structure-pulse"></div>
                                    </div>
                                    <div class="structure-info">
                                        <div class="structure-name">Left Atrium</div>
                                        <div class="structure-details">
                                            <span class="structure-stat">📊 40-65ml</span>
                                            <span class="structure-stat">💉 8-12mmHg</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="structure-item" data-structure="right-atrium" style="color: #4ecdc4;">
                                    <div class="structure-indicator" data-abbr="RA">
                                        <div class="structure-pulse"></div>
                                    </div>
                                    <div class="structure-info">
                                        <div class="structure-name">Right Atrium</div>
                                        <div class="structure-details">
                                            <span class="structure-stat">📊 40-60ml</span>
                                            <span class="structure-stat">💉 2-8mmHg</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="structure-item" data-structure="left-ventricle" style="color: #ffe66d;">
                                    <div class="structure-indicator" data-abbr="LV">
                                        <div class="structure-pulse"></div>
                                    </div>
                                    <div class="structure-info">
                                        <div class="structure-name">Left Ventricle</div>
                                        <div class="structure-details">
                                            <span class="structure-stat">📊 70-100ml</span>
                                            <span class="structure-stat">💉 120/8mmHg</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="structure-item" data-structure="right-ventricle" style="color: #95e77e;">
                                    <div class="structure-indicator" data-abbr="RV">
                                        <div class="structure-pulse"></div>
                                    </div>
                                    <div class="structure-info">
                                        <div class="structure-name">Right Ventricle</div>
                                        <div class="structure-details">
                                            <span class="structure-stat">📊 70-100ml</span>
                                            <span class="structure-stat">💉 25/4mmHg</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Cardiac Valves -->
                        <div class="category-section" id="cat-valves">
                            <div class="category-header" onclick="toggleCategory('valves')">
                                <div class="category-info">
                                    <div class="category-icon">🔄</div>
                                    <div class="category-details">
                                        <div class="category-name">Cardiac Valves</div>
                                        <div class="category-count">4 structures</div>
                                    </div>
                                </div>
                                <div class="category-arrow">▼</div>
                            </div>
                            <div class="category-items">
                                <div class="structure-item" data-structure="mitral-valve" style="color: #b4a0ff;">
                                    <div class="structure-indicator" data-abbr="MV">
                                        <div class="structure-pulse"></div>
                                    </div>
                                    <div class="structure-info">
                                        <div class="structure-name">Mitral Valve</div>
                                        <div class="structure-details">
                                            <span class="structure-stat">📐 4-6cm²</span>
                                            <span class="structure-stat">🔄 Bicuspid</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="structure-item" data-structure="aortic-valve" style="color: #ff9ff3;">
                                    <div class="structure-indicator" data-abbr="AV">
                                        <div class="structure-pulse"></div>
                                    </div>
                                    <div class="structure-info">
                                        <div class="structure-name">Aortic Valve</div>
                                        <div class="structure-details">
                                            <span class="structure-stat">📐 3-4cm²</span>
                                            <span class="structure-stat">🔄 Tricuspid</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="structure-item" data-structure="tricuspid-valve" style="color: #ffd93d;">
                                    <div class="structure-indicator" data-abbr="TV">
                                        <div class="structure-pulse"></div>
                                    </div>
                                    <div class="structure-info">
                                        <div class="structure-name">Tricuspid Valve</div>
                                        <div class="structure-details">
                                            <span class="structure-stat">📐 7-9cm²</span>
                                            <span class="structure-stat">🔄 Three leaflets</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="structure-item" data-structure="pulmonary-valve" style="color: #6bcf7f;">
                                    <div class="structure-indicator" data-abbr="PV">
                                        <div class="structure-pulse"></div>
                                    </div>
                                    <div class="structure-info">
                                        <div class="structure-name">Pulmonary Valve</div>
                                        <div class="structure-details">
                                            <span class="structure-stat">📐 2-4cm²</span>
                                            <span class="structure-stat">🔄 Semilunar</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Coronary Arteries -->
                        <div class="category-section" id="cat-coronary">
                            <div class="category-header" onclick="toggleCategory('coronary')">
                                <div class="category-info">
                                    <div class="category-icon">🩸</div>
                                    <div class="category-details">
                                        <div class="category-name">Coronary Circulation</div>
                                        <div class="category-count">8 structures</div>
                                    </div>
                                </div>
                                <div class="category-arrow">▼</div>
                            </div>
                            <div class="category-items">
                                <div class="structure-item" data-structure="lmca" style="color: #ff3333;">
                                    <div class="structure-indicator" data-abbr="LM">
                                        <div class="structure-pulse"></div>
                                    </div>
                                    <div class="structure-info">
                                        <div class="structure-name">Left Main Coronary</div>
                                        <div class="structure-details">
                                            <span class="structure-stat">⌀ 4-5mm</span>
                                            <span class="structure-stat">📍 Left sinus</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="structure-item" data-structure="lad" style="color: #ff4444;">
                                    <div class="structure-indicator" data-abbr="LAD">
                                        <div class="structure-pulse"></div>
                                    </div>
                                    <div class="structure-info">
                                        <div class="structure-name">Left Anterior Descending</div>
                                        <div class="structure-details">
                                            <span class="structure-stat">⌀ 3-4mm</span>
                                            <span class="structure-stat">🎯 Anterior wall</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="structure-item" data-structure="lcx" style="color: #ff5555;">
                                    <div class="structure-indicator" data-abbr="LCX">
                                        <div class="structure-pulse"></div>
                                    </div>
                                    <div class="structure-info">
                                        <div class="structure-name">Left Circumflex</div>
                                        <div class="structure-details">
                                            <span class="structure-stat">⌀ 3-4mm</span>
                                            <span class="structure-stat">🎯 Lateral wall</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="structure-item" data-structure="rca" style="color: #ff6666;">
                                    <div class="structure-indicator" data-abbr="RCA">
                                        <div class="structure-pulse"></div>
                                    </div>
                                    <div class="structure-info">
                                        <div class="structure-name">Right Coronary Artery</div>
                                        <div class="structure-details">
                                            <span class="structure-stat">⌀ 3-4mm</span>
                                            <span class="structure-stat">🎯 Inferior wall</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Conduction System -->
                        <div class="category-section" id="cat-conduction">
                            <div class="category-header" onclick="toggleCategory('conduction')">
                                <div class="category-info">
                                    <div class="category-icon">⚡</div>
                                    <div class="category-details">
                                        <div class="category-name">Conduction System</div>
                                        <div class="category-count">6 structures</div>
                                    </div>
                                </div>
                                <div class="category-arrow">▼</div>
                            </div>
                            <div class="category-items">
                                <div class="structure-item" data-structure="sa-node" style="color: #ffaa00;">
                                    <div class="structure-indicator" data-abbr="SA">
                                        <div class="structure-pulse"></div>
                                    </div>
                                    <div class="structure-info">
                                        <div class="structure-name">Sinoatrial Node</div>
                                        <div class="structure-details">
                                            <span class="structure-stat">⚡ 60-100bpm</span>
                                            <span class="structure-stat">📍 RA junction</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="structure-item" data-structure="av-node" style="color: #ffbb00;">
                                    <div class="structure-indicator" data-abbr="AV">
                                        <div class="structure-pulse"></div>
                                    </div>
                                    <div class="structure-info">
                                        <div class="structure-name">Atrioventricular Node</div>
                                        <div class="structure-details">
                                            <span class="structure-stat">⚡ 40-60bpm</span>
                                            <span class="structure-stat">📍 Koch triangle</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="structure-item" data-structure="bundle-his" style="color: #ffcc00;">
                                    <div class="structure-indicator" data-abbr="BH">
                                        <div class="structure-pulse"></div>
                                    </div>
                                    <div class="structure-info">
                                        <div class="structure-name">Bundle of His</div>
                                        <div class="structure-details">
                                            <span class="structure-stat">⚡ 20-40bpm</span>
                                            <span class="structure-stat">📍 IV septum</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Information Panel -->
            <div class="info-panel" id="infoPanel">
                <div class="panel-toggle" onclick="togglePanel('info')" style="left: -25px;">
                    <span id="infoToggleIcon">▶</span>
                </div>
                <div class="info-header">
                    <div class="info-title" id="infoTitle">Cardiac Structure Analysis</div>
                    <div class="info-subtitle" id="infoSubtitle">Select a structure for detailed information</div>
                </div>
                <div class="info-content">
                    <!-- Anatomical Data Section -->
                    <div class="info-section">
                        <div class="section-header">
                            <div class="section-icon">📊</div>
                            <div class="section-title">Anatomical Measurements</div>
                        </div>
                        <div class="data-grid" id="anatomicalData">
                            <div class="data-card">
                                <div class="data-label">Wall Thickness</div>
                                <div class="data-value">
                                    <span id="wallThickness">--</span>
                                    <span class="data-unit">mm</span>
                                </div>
                                <div class="data-trend">
                                    <span>↑</span> Normal range
                                </div>
                            </div>
                            <div class="data-card">
                                <div class="data-label">Chamber Volume</div>
                                <div class="data-value">
                                    <span id="chamberVolume">--</span>
                                    <span class="data-unit">ml</span>
                                </div>
                                <div class="data-trend">
                                    <span>→</span> Within limits
                                </div>
                            </div>
                            <div class="data-card">
                                <div class="data-label">Pressure</div>
                                <div class="data-value">
                                    <span id="pressure">--</span>
                                    <span class="data-unit">mmHg</span>
                                </div>
                                <div class="data-trend">
                                    <span>↑</span> Systolic phase
                                </div>
                            </div>
                            <div class="data-card">
                                <div class="data-label">Flow Rate</div>
                                <div class="data-value">
                                    <span id="flowRate">--</span>
                                    <span class="data-unit">L/min</span>
                                </div>
                                <div class="data-trend down">
                                    <span>↓</span> Diastolic phase
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Physiological Function -->
                    <div class="info-section">
                        <div class="section-header">
                            <div class="section-icon">💓</div>
                            <div class="section-title">Physiological Function</div>
                        </div>
                        <div id="physiologyInfo" style="padding: 15px; background: rgba(0,0,0,0.2); border-radius: 12px;">
                            <p style="color: var(--text-secondary); line-height: 1.6;">
                                Select an anatomical structure to view its physiological function and clinical significance.
                            </p>
                        </div>
                    </div>

                    <!-- Clinical Correlations -->
                    <div class="info-section">
                        <div class="section-header">
                            <div class="section-icon">🏥</div>
                            <div class="section-title">Clinical Correlations</div>
                        </div>
                        <div id="clinicalInfo" style="padding: 15px; background: rgba(0,0,0,0.2); border-radius: 12px;">
                            <p style="color: var(--text-secondary); line-height: 1.6;">
                                Clinical pathologies and surgical considerations will appear here.
                            </p>
                        </div>
                    </div>

                    <!-- Surgical Approaches -->
                    <div class="info-section">
                        <div class="section-header">
                            <div class="section-icon">⚕️</div>
                            <div class="section-title">Surgical Approaches</div>
                        </div>
                        <div id="surgicalInfo" style="padding: 15px; background: rgba(0,0,0,0.2); border-radius: 12px;">
                            <p style="color: var(--text-secondary); line-height: 1.6;">
                                Surgical techniques and approaches for the selected structure.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Control Dock -->
            <div class="control-dock">
                <div class="control-group">
                    <div class="control-btn" onclick="toggleRotation()" id="rotateBtn">
                        <span class="control-icon">🔄</span>
                        <span class="control-label">Rotate</span>
                    </div>
                    <div class="control-btn" onclick="toggleCrosssection()" id="crossBtn">
                        <span class="control-icon">✂️</span>
                        <span class="control-label">Cross</span>
                    </div>
                    <div class="control-btn" onclick="toggleXray()" id="xrayBtn">
                        <span class="control-icon">📡</span>
                        <span class="control-label">X-Ray</span>
                    </div>
                    <div class="control-btn" onclick="toggleBloodFlow()" id="flowBtn">
                        <span class="control-icon">💉</span>
                        <span class="control-label">Flow</span>
                    </div>
                    <div class="control-btn" onclick="toggleLabels()" id="labelsBtn">
                        <span class="control-icon">🏷️</span>
                        <span class="control-label">Labels</span>
                    </div>
                </div>

                <div class="control-separator"></div>

                <div class="mode-switcher">
                    <button class="mode-btn active" onclick="setMode('explore')">Explore</button>
                    <button class="mode-btn" onclick="setMode('learn')">Learn</button>
                    <button class="mode-btn" onclick="setMode('practice')">Practice</button>
                    <button class="mode-btn" onclick="setMode('assess')">Assess</button>
                </div>

                <div class="control-separator"></div>

                <div class="control-group">
                    <div class="control-btn" onclick="resetView()">
                        <span class="control-icon">🏠</span>
                        <span class="control-label">Reset</span>
                    </div>
                    <div class="control-btn" onclick="takeScreenshot()">
                        <span class="control-icon">📸</span>
                        <span class="control-label">Capture</span>
                    </div>
                    <div class="control-btn" onclick="toggleFullscreen()">
                        <span class="control-icon">⛶</span>
                        <span class="control-label">Full</span>
                    </div>
                    <div class="control-btn" onclick="showSettings()">
                        <span class="control-icon">⚙️</span>
                        <span class="control-label">Settings</span>
                    </div>
                </div>
            </div>

            <!-- ECG Monitor -->
            <div class="ecg-monitor">
                <svg class="ecg-trace" viewBox="0 0 300 60">
                    <defs>
                        <pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse">
                            <path d="M 10 0 L 0 0 0 10" fill="none" class="ecg-grid"/>
                        </pattern>
                    </defs>
                    <rect width="300" height="60" fill="url(#grid)"/>
                    <path id="ecgPath" class="ecg-line" d="M0,30 L300,30"/>
                </svg>
            </div>

            <!-- Learning Interface -->
            <div class="learning-interface" id="learningInterface">
                <div class="learning-container">
                    <div class="learning-sidebar">
                        <div class="learning-progress">
                            <div class="progress-header">
                                <div class="progress-title">Overall Progress</div>
                                <div class="progress-percentage" id="progressPercentage">0%</div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                            </div>
                        </div>
                        <div class="learning-modules" id="learningModules">
                            <!-- Modules will be dynamically generated -->
                        </div>
                    </div>
                    <div class="learning-content" id="learningContent">
                        <!-- Learning content will be dynamically loaded -->
                    </div>
                </div>
            </div>

            <!-- Assessment Interface -->
            <div class="assessment-interface" id="assessmentInterface">
                <div class="assessment-container">
                    <!-- Assessment content will be dynamically loaded -->
                </div>
            </div>

            <!-- Tooltip -->
            <div class="tooltip" id="tooltip">
                <div class="tooltip-header">Structure Name</div>
                <div class="tooltip-body">Additional information</div>
            </div>

            <!-- Notification -->
            <div class="notification" id="notification">
                <div class="notification-header">
                    <div class="notification-icon info">ℹ️</div>
                    <div class="notification-content">
                        <div class="notification-title">System Ready</div>
                        <div class="notification-message">CardioVis Sim initialized successfully</div>
                    </div>
                </div>
                <div class="notification-close" onclick="closeNotification()">×</div>
            </div>
        </div>
    </div>

    <script>
        // CardioVis Sim - Advanced Cardiac Surgery Training System
        class CardioVisSim {
            constructor() {
                this.version = '3.0';
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.composer = null;
                this.heart = null;
                this.structures = {};
                this.materials = {};
                this.textures = {};
                this.animations = {};
                this.particles = [];
                this.labels = [];
                
                // Interaction
                this.raycaster = new THREE.Raycaster();
                this.mouse = new THREE.Vector2();
                this.selectedStructure = null;
                this.hoveredStructure = null;
                
                // Modes and states
                this.mode = 'explore';
                this.rotationEnabled = true;
                this.bloodFlowEnabled = false;
                this.xrayMode = false;
                this.crossSectionEnabled = false;
                this.labelsEnabled = false;
                
                // Learning system
                this.currentModule = 0;
                this.currentLesson = 0;
                this.completedModules = [];
                this.learningModules = this.generateLearningModules();
                
                // Assessment system
                this.assessmentQuestions = this.generateAssessmentQuestions();
                this.currentQuestion = 0;
                this.assessmentScore = 0;
                
                // Animation loops
                this.animationFrame = 0;
                this.heartbeatPhase = 0;
                this.bloodFlowPhase = 0;
                
                // Performance
                this.stats = null;
                
                this.init();
            }

            async init() {
                try {
                    // Setup 3D environment
                    this.setupScene();
                    this.setupCamera();
                    this.setupRenderer();
                    this.setupLighting();
                    this.setupPostProcessing();
                    
                    // Create heart model
                    await this.createPhotorealisticHeart();
                    
                    // Setup interactions
                    this.setupControls();
                    this.setupEventListeners();
                    
                    // Initialize UI
                    this.initializeUI();
                    
                    // Start animation
                    this.animate();
                    
                    // Hide loading screen
                    setTimeout(() => {
                        document.getElementById('loadingScreen').classList.add('hidden');
                        this.showNotification('Welcome to CardioVis Sim', 'Your advanced cardiac training system is ready', 'success');
                    }, 4000);
                    
                } catch (error) {
                    console.error('Initialization error:', error);
                    this.showNotification('Initialization Error', 'Please refresh the page', 'error');
                }
            }

            setupScene() {
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x0a0e27);
                this.scene.fog = new THREE.FogExp2(0x0a0e27, 0.015);
                
                // Add environment map for realistic reflections
                const envTexture = this.createEnvironmentMap();
                this.scene.environment = envTexture;
            }

            setupCamera() {
                const aspect = window.innerWidth / window.innerHeight;
                this.camera = new THREE.PerspectiveCamera(45, aspect, 0.1, 1000);
                this.camera.position.set(0, 0, 40);
                this.camera.lookAt(0, 0, 0);
            }

            setupRenderer() {
                this.renderer = new THREE.WebGLRenderer({
                    canvas: document.getElementById('canvas'),
                    antialias: true,
                    alpha: true,
                    powerPreference: 'high-performance'
                });
                
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                this.renderer.toneMapping = THREE.ACESFilmicToneMapping;
                this.renderer.toneMappingExposure = 1.2;
                this.renderer.outputEncoding = THREE.sRGBEncoding;
                this.renderer.physicallyCorrectLights = true;
            }

            setupLighting() {
                // Ambient light for base illumination
                const ambientLight = new THREE.AmbientLight(0x404040, 0.3);
                this.scene.add(ambientLight);
                
                // Main key light
                const keyLight = new THREE.DirectionalLight(0xffffff, 1);
                keyLight.position.set(10, 15, 10);
                keyLight.castShadow = true;
                keyLight.shadow.mapSize.width = 4096;
                keyLight.shadow.mapSize.height = 4096;
                keyLight.shadow.camera.near = 0.5;
                keyLight.shadow.camera.far = 100;
                keyLight.shadow.camera.left = -30;
                keyLight.shadow.camera.right = 30;
                keyLight.shadow.camera.top = 30;
                keyLight.shadow.camera.bottom = -30;
                keyLight.shadow.bias = -0.0005;
                this.scene.add(keyLight);
                
                // Fill light
                const fillLight = new THREE.DirectionalLight(0x88ccff, 0.5);
                fillLight.position.set(-10, 5, -10);
                this.scene.add(fillLight);
                
                // Rim light for edge definition
                const rimLight = new THREE.DirectionalLight(0xff6688, 0.3);
                rimLight.position.set(0, -10, -15);
                this.scene.add(rimLight);
                
                // Point lights for specific highlights
                const colors = [0xff0040, 0x0080ff, 0x00ff80];
                colors.forEach((color, i) => {
                    const light = new THREE.PointLight(color, 0.5, 50);
                    const angle = (i / colors.length) * Math.PI * 2;
                    light.position.set(
                        Math.cos(angle) * 20,
                        Math.sin(angle) * 10,
                        10
                    );
                    this.scene.add(light);
                });
                
                // Spot light for dramatic effect
                const spotLight = new THREE.SpotLight(0xffffff, 0.5);
                spotLight.position.set(0, 30, 20);
                spotLight.angle = Math.PI / 6;
                spotLight.penumbra = 0.3;
                spotLight.decay = 2;
                spotLight.distance = 100;
                spotLight.castShadow = true;
                spotLight.shadow.mapSize.width = 2048;
                spotLight.shadow.mapSize.height = 2048;
                this.scene.add(spotLight);
                
                // Hemisphere light for realistic ambient
                const hemiLight = new THREE.HemisphereLight(0x88ccff, 0x002244, 0.3);
                this.scene.add(hemiLight);
            }

            setupPostProcessing() {
                // Advanced post-processing effects would go here
                // For now, using standard renderer
            }

            createEnvironmentMap() {
                // Create a simple environment texture for reflections
                const canvas = document.createElement('canvas');
                canvas.width = 512;
                canvas.height = 512;
                const ctx = canvas.getContext('2d');
                
                const gradient = ctx.createRadialGradient(256, 256, 0, 256, 256, 256);
                gradient.addColorStop(0, '#1a3a52');
                gradient.addColorStop(0.5, '#0a1929');
                gradient.addColorStop(1, '#000000');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 512, 512);
                
                const texture = new THREE.CanvasTexture(canvas);
                texture.mapping = THREE.EquirectangularReflectionMapping;
                return texture;
            }

            async createPhotorealisticHeart() {
                const heartGroup = new THREE.Group();
                heartGroup.name = 'heart';
                
                // Advanced materials for photorealistic rendering
                const createAdvancedMaterial = (color, options = {}) => {
                    return new THREE.MeshPhysicalMaterial({
                        color: color,
                        metalness: options.metalness || 0.0,
                        roughness: options.roughness || 0.4,
                        clearcoat: options.clearcoat || 0.3,
                        clearcoatRoughness: options.clearcoatRoughness || 0.2,
                        reflectivity: options.reflectivity || 0.5,
                        transmission: options.transmission || 0,
                        thickness: options.thickness || 1,
                        envMapIntensity: 1,
                        side: THREE.DoubleSide,
                        transparent: true,
                        opacity: options.opacity || 0.95,
                        emissive: options.emissive || color,
                        emissiveIntensity: options.emissiveIntensity || 0.02
                    });
                };
                
                // Create noise texture for realistic surface
                const noiseTexture = this.createNoiseTexture();
                
                // Detailed anatomical structures with medical accuracy
                const anatomicalStructures = {
                    // Left Atrium
                    'left-atrium': {
                        geometry: () => {
                            const shape = new THREE.SphereGeometry(4, 128, 128);
                            // Deform for anatomical accuracy
                            const positions = shape.attributes.position;
                            for (let i = 0; i < positions.count; i++) {
                                const x = positions.getX(i);
                                const y = positions.getY(i);
                                const z = positions.getZ(i);
                                
                                // Create irregular atrial shape
                                const noise = Math.sin(x * 2) * 0.3 + Math.cos(y * 3) * 0.2;
                                positions.setX(i, x * (1 + noise * 0.1));
                                positions.setY(i, y * 0.85); // Flatten slightly
                                positions.setZ(i, z * (1 + noise * 0.05));
                            }
                            shape.computeVertexNormals();
                            return shape;
                        },
                        material: createAdvancedMaterial(0xff6b6b, {
                            roughness: 0.35,
                            clearcoat: 0.4,
                            emissiveIntensity: 0.03
                        }),
                        position: [-3.5, 5, 0],
                        scale: [1, 0.9, 0.95],
                        data: {
                            name: 'Left Atrium',
                            volume: { min: 40, max: 65, unit: 'ml' },
                            pressure: { systolic: 12, diastolic: 8, unit: 'mmHg' },
                            wallThickness: { value: 2.5, unit: 'mm' },
                            function: 'Receives oxygenated blood from the four pulmonary veins and contracts to fill the left ventricle during ventricular diastole.',
                            clinical: 'Common site for thrombus formation in atrial fibrillation. Left atrial enlargement is associated with mitral valve disease.',
                            surgical: 'Access point for mitral valve surgery via left atriotomy. Maze procedure performed here for AF treatment.'
                        }
                    },
                    
                    // Right Atrium  
                    'right-atrium': {
                        geometry: () => {
                            const shape = new THREE.SphereGeometry(4, 128, 128);
                            const positions = shape.attributes.position;
                            for (let i = 0; i < positions.count; i++) {
                                const x = positions.getX(i);
                                const y = positions.getY(i);
                                const z = positions.getZ(i);
                                
                                // Create trabeculated appearance
                                const noise = Math.sin(x * 3) * 0.2 + Math.cos(z * 2) * 0.15;
                                positions.setX(i, x * (1 + noise * 0.08));
                                positions.setY(i, y * 0.85);
                                positions.setZ(i, z * (1 + noise * 0.06));
                            }
                            shape.computeVertexNormals();
                            return shape;
                        },
                        material: createAdvancedMaterial(0x4ecdc4, {
                            roughness: 0.38,
                            clearcoat: 0.35
                        }),
                        position: [3.5, 5, 0],
                        scale: [1, 0.9, 0.95],
                        data: {
                            name: 'Right Atrium',
                            volume: { min: 40, max: 60, unit: 'ml' },
                            pressure: { systolic: 8, diastolic: 2, unit: 'mmHg' },
                            wallThickness: { value: 2, unit: 'mm' },
                            function: 'Receives deoxygenated blood from superior and inferior vena cava. Contains the sinoatrial node (primary pacemaker).',
                            clinical: 'Central venous pressure measured here. Site of atrial septal defects. Contains crista terminalis and pectinate muscles.',
                            surgical: 'Cannulation site for cardiopulmonary bypass. Access for tricuspid valve repair and ASD closure.'
                        }
                    },
                    
                    // Left Ventricle
                    'left-ventricle': {
                        geometry: () => {
                            const shape = new THREE.ConeGeometry(4, 8, 128, 64, false);
                            const positions = shape.attributes.position;
                            for (let i = 0; i < positions.count; i++) {
                                const x = positions.getX(i);
                                const y = positions.getY(i);
                                const z = positions.getZ(i);
                                
                                // Create elliptical cross-section
                                const r = Math.sqrt(x * x + z * z);
                                const theta = Math.atan2(z, x);
                                const newR = r * (1 + Math.sin(theta * 2) * 0.1);
                                
                                positions.setX(i, newR * Math.cos(theta));
                                positions.setZ(i, newR * Math.sin(theta) * 0.8);
                                
                                // Add trabeculations
                                if (y < -2) {
                                    const noise = Math.sin(theta * 8) * 0.05;
                                    positions.setX(i, positions.getX(i) * (1 + noise));
                                    positions.setZ(i, positions.getZ(i) * (1 + noise));
                                }
                            }
                            shape.computeVertexNormals();
                            return shape;
                        },
                        material: createAdvancedMaterial(0xffe66d, {
                            roughness: 0.32,
                            clearcoat: 0.45,
                            emissiveIntensity: 0.04
                        }),
                        position: [-2.5, -2, 1],
                        rotation: [Math.PI, 0, 0.15],
                        scale: [1.3, 1, 1.1],
                        data: {
                            name: 'Left Ventricle',
                            volume: { min: 70, max: 100, unit: 'ml' },
                            pressure: { systolic: 120, diastolic: 8, unit: 'mmHg' },
                            wallThickness: { value: 12, unit: 'mm' },
                            ejectionFraction: { value: 60, unit: '%' },
                            function: 'Main pumping chamber generating systemic circulation. Thickest myocardial wall to generate high pressure.',
                            clinical: 'Hypertrophy in hypertension. Infarction commonly affects LAD territory. Ejection fraction key diagnostic parameter.',
                            surgical: 'LVAD insertion site. Ventriculotomy for VSD repair. Myectomy for HOCM. Careful preservation of papillary muscles.'
                        }
                    },
                    
                    // Right Ventricle
                    'right-ventricle': {
                        geometry: () => {
                            const shape = new THREE.ConeGeometry(3.5, 7, 96, 48, false);
                            const positions = shape.attributes.position;
                            for (let i = 0; i < positions.count; i++) {
                                const x = positions.getX(i);
                                const y = positions.getY(i);
                                const z = positions.getZ(i);
                                
                                // Create crescent shape
                                positions.setX(i, x * 1.2);
                                positions.setZ(i, z * 0.7);
                                
                                // Add moderator band region
                                if (y < -1 && y > -3) {
                                    const band = Math.sin(x * 2) * 0.1;
                                    positions.setY(i, y + band);
                                }
                            }
                            shape.computeVertexNormals();
                            return shape;
                        },
                        material: createAdvancedMaterial(0x95e77e, {
                            roughness: 0.36,
                            clearcoat: 0.35
                        }),
                        position: [2.5, -2, 2],
                        rotation: [Math.PI, 0, -0.15],
                        scale: [1.1, 1, 0.9],
                        data: {
                            name: 'Right Ventricle',
                            volume: { min: 70, max: 100, unit: 'ml' },
                            pressure: { systolic: 25, diastolic: 4, unit: 'mmHg' },
                            wallThickness: { value: 4, unit: 'mm' },
                            function: 'Pumps deoxygenated blood to pulmonary circulation. Thin wall due to low pulmonary resistance.',
                            clinical: 'RV failure in pulmonary hypertension. RVOT obstruction in Tetralogy of Fallot. Moderator band visible.',
                            surgical: 'RVOT reconstruction. Pulmonary valve replacement. VSD patch closure from RA or RV approach.'
                        }
                    },
                    
                    // Mitral Valve
                    'mitral-valve': {
                        geometry: () => {
                            const inner = 1.2;
                            const outer = 1.6;
                            const shape = new THREE.RingGeometry(inner, outer, 64, 8);
                            
                            // Create leaflet appearance
                            const positions = shape.attributes.position;
                            for (let i = 0; i < positions.count; i++) {
                                const x = positions.getX(i);
                                const y = positions.getY(i);
                                const theta = Math.atan2(y, x);
                                
                                // Bicuspid shape
                                const leaflet = Math.sin(theta * 1) * 0.1;
                                positions.setZ(i, leaflet);
                            }
                            shape.computeVertexNormals();
                            return shape;
                        },
                        material: createAdvancedMaterial(0xb4a0ff, {
                            roughness: 0.25,
                            clearcoat: 0.5,
                            opacity: 0.9,
                            emissiveIntensity: 0.05
                        }),
                        position: [-3, 1.5, 0],
                        rotation: [Math.PI / 2, 0, 0],
                        data: {
                            name: 'Mitral Valve',
                            area: { value: 5, unit: 'cm²' },
                            gradient: { mean: 3, peak: 7, unit: 'mmHg' },
                            leaflets: 'Anterior (A2) and Posterior (P2)',
                            function: 'Bicuspid valve preventing backflow from LV to LA. Complex subvalvular apparatus with chordae tendineae.',
                            clinical: 'Mitral regurgitation most common. Stenosis in rheumatic disease. Prolapse affects 2-3% of population.',
                            surgical: 'Repair preferred over replacement. Edge-to-edge repair, annuloplasty ring, neochordae construction.'
                        }
                    },
                    
                    // Aortic Valve
                    'aortic-valve': {
                        geometry: () => {
                            const shape = new THREE.RingGeometry(0.9, 1.3, 64, 8);
                            const positions = shape.attributes.position;
                            
                            for (let i = 0; i < positions.count; i++) {
                                const x = positions.getX(i);
                                const y = positions.getY(i);
                                const theta = Math.atan2(y, x);
                                
                                // Tricuspid semilunar shape
                                const cusp = Math.sin(theta * 3) * 0.08;
                                positions.setZ(i, cusp);
                            }
                            shape.computeVertexNormals();
                            return shape;
                        },
                        material: createAdvancedMaterial(0xff9ff3, {
                            roughness: 0.28,
                            clearcoat: 0.5,
                            opacity: 0.9
                        }),
                        position: [0, 0.5, 0],
                        rotation: [Math.PI / 2, 0, 0],
                        data: {
                            name: 'Aortic Valve',
                            area: { value: 3.5, unit: 'cm²' },
                            gradient: { mean: 10, peak: 20, unit: 'mmHg' },
                            cusps: 'Right, Left, and Non-coronary',
                            function: 'Tricuspid semilunar valve preventing backflow from aorta to LV. Opens during systole.',
                            clinical: 'Stenosis causes LVH. Regurgitation in bicuspid valve, endocarditis. Critical AS requires urgent intervention.',
                            surgical: 'TAVR for high-risk patients. Mechanical vs bioprosthetic replacement. Ross procedure in young patients.'
                        }
                    },
                    
                    // Tricuspid Valve
                    'tricuspid-valve': {
                        geometry: () => {
                            return new THREE.RingGeometry(1.3, 1.7, 64, 8);
                        },
                        material: createAdvancedMaterial(0xffd93d, {
                            roughness: 0.3,
                            clearcoat: 0.4,
                            opacity: 0.9
                        }),
                        position: [3, 1.5, 0],
                        rotation: [Math.PI / 2, 0, 0],
                        data: {
                            name: 'Tricuspid Valve',
                            area: { value: 8, unit: 'cm²' },
                            gradient: { mean: 2, peak: 5, unit: 'mmHg' },
                            leaflets: 'Anterior, Posterior, Septal',
                            function: 'Three-leaflet valve between RA and RV. Largest valve area, lowest pressure gradient.',
                            clinical: 'Functional TR common in RV dilation. Endocarditis in IV drug use. Ebstein anomaly congenital defect.',
                            surgical: 'Annuloplasty for functional TR. De Vega vs ring annuloplasty. Rarely requires replacement.'
                        }
                    },
                    
                    // Pulmonary Valve
                    'pulmonary-valve': {
                        geometry: () => {
                            return new THREE.RingGeometry(0.8, 1.1, 64, 8);
                        },
                        material: createAdvancedMaterial(0x6bcf7f, {
                            roughness: 0.3,
                            clearcoat: 0.4,
                            opacity: 0.9
                        }),
                        position: [2, 0.5, 3],
                        rotation: [Math.PI / 2, 0, 0],
                        data: {
                            name: 'Pulmonary Valve',
                            area: { value: 3, unit: 'cm²' },
                            gradient: { mean: 5, peak: 10, unit: 'mmHg' },
                            cusps: 'Anterior, Right, Left',
                            function: 'Semilunar valve controlling flow from RV to pulmonary artery. Most anterior cardiac valve.',
                            clinical: 'Stenosis in Tetralogy of Fallot. Regurgitation post-repair. Absent in pulmonary atresia.',
                            surgical: 'Balloon valvuloplasty first-line. Transannular patch repair. Melody valve for percutaneous replacement.'
                        }
                    }
                };
                
                // Create all structures
                for (const [key, data] of Object.entries(anatomicalStructures)) {
                    const geometry = typeof data.geometry === 'function' ? data.geometry() : data.geometry;
                    const mesh = new THREE.Mesh(geometry, data.material);
                    
                    mesh.name = key;
                    mesh.userData = data.data;
                    
                    if (data.position) mesh.position.set(...data.position);
                    if (data.rotation) mesh.rotation.set(...data.rotation);
                    if (data.scale) mesh.scale.set(...data.scale);
                    
                    mesh.castShadow = true;
                    mesh.receiveShadow = true;
                    
                    this.structures[key] = mesh;
                    heartGroup.add(mesh);
                }
                
                // Add coronary arteries
                this.createCoronaryArteries(heartGroup);
                
                // Add conduction system
                this.createConductionSystem(heartGroup);
                
                // Add blood flow particles
                this.createBloodFlowSystem(heartGroup);
                
                // Add anatomical labels
                this.createAnatomicalLabels(heartGroup);
                
                this.heart = heartGroup;
                this.scene.add(heartGroup);
                
                // Create background elements
                this.createBackgroundElements();
            }

            createNoiseTexture() {
                const canvas = document.createElement('canvas');
                canvas.width = 512;
                canvas.height = 512;
                const ctx = canvas.getContext('2d');
                
                const imageData = ctx.createImageData(512, 512);
                const data = imageData.data;
                
                for (let i = 0; i < data.length; i += 4) {
                    const noise = Math.random() * 255;
                    data[i] = noise;
                    data[i + 1] = noise;
                    data[i + 2] = noise;
                    data[i + 3] = 255;
                }
                
                ctx.putImageData(imageData, 0, 0);
                
                const texture = new THREE.CanvasTexture(canvas);
                texture.wrapS = THREE.RepeatWrapping;
                texture.wrapT = THREE.RepeatWrapping;
                texture.repeat.set(4, 4);
                
                return texture;
            }

            createCoronaryArteries(parent) {
                const vesselMaterial = new THREE.MeshPhysicalMaterial({
                    color: 0xcc0000,
                    metalness: 0.1,
                    roughness: 0.3,
                    clearcoat: 0.6,
                    clearcoatRoughness: 0.1,
                    transparent: true,
                    opacity: 0.9,
                    emissive: 0x660000,
                    emissiveIntensity: 0.1
                });
                
                // Left Main Coronary Artery
                const lmcaCurve = new THREE.CatmullRomCurve3([
                    new THREE.Vector3(-1, 3, 4),
                    new THREE.Vector3(-2, 2.5, 4.2),
                    new THREE.Vector3(-3, 2, 4)
                ]);
                const lmcaGeometry = new THREE.TubeGeometry(lmcaCurve, 32, 0.25, 16, false);
                const lmca = new THREE.Mesh(lmcaGeometry, vesselMaterial);
                lmca.name = 'lmca';
                lmca.userData = {
                    name: 'Left Main Coronary Artery',
                    diameter: '4-5mm',
                    origin: 'Left coronary sinus',
                    branches: 'LAD and LCX',
                    territory: '70% of myocardium'
                };
                parent.add(lmca);
                
                // LAD (Left Anterior Descending)
                const ladCurve = new THREE.CatmullRomCurve3([
                    new THREE.Vector3(-3, 2, 4),
                    new THREE.Vector3(-3.5, 0, 4.5),
                    new THREE.Vector3(-3.8, -3, 4),
                    new THREE.Vector3(-3.5, -5, 3)
                ]);
                const ladGeometry = new THREE.TubeGeometry(ladCurve, 64, 0.2, 16, false);
                const lad = new THREE.Mesh(ladGeometry, vesselMaterial);
                lad.name = 'lad';
                lad.userData = {
                    name: 'Left Anterior Descending Artery',
                    diameter: '3-4mm',
                    branches: 'Diagonal and septal perforators',
                    territory: 'Anterior wall and septum',
                    clinical: 'Widow maker - most critical for MI'
                };
                parent.add(lad);
                
                // LCX (Left Circumflex)
                const lcxCurve = new THREE.CatmullRomCurve3([
                    new THREE.Vector3(-3, 2, 4),
                    new THREE.Vector3(-4, 1, 2),
                    new THREE.Vector3(-4, -1, -1),
                    new THREE.Vector3(-2, -2, -3),
                    new THREE.Vector3(1, -1, -3)
                ]);
                const lcxGeometry = new THREE.TubeGeometry(lcxCurve, 64, 0.18, 16, false);
                const lcx = new THREE.Mesh(lcxGeometry, vesselMaterial);
                lcx.name = 'lcx';
                lcx.userData = {
                    name: 'Left Circumflex Artery',
                    diameter: '3-4mm',
                    branches: 'Obtuse marginal branches',
                    territory: 'Lateral and posterior walls',
                    clinical: 'Dominance determines PDA origin'
                };
                parent.add(lcx);
                
                // RCA (Right Coronary Artery)
                const rcaCurve = new THREE.CatmullRomCurve3([
                    new THREE.Vector3(1, 3, 4),
                    new THREE.Vector3(3, 2, 4.2),
                    new THREE.Vector3(4.5, 0, 3.5),
                    new THREE.Vector3(4, -2, 2),
                    new THREE.Vector3(2, -3, 0),
                    new THREE.Vector3(0, -3, -2)
                ]);
                const rcaGeometry = new THREE.TubeGeometry(rcaCurve, 64, 0.2, 16, false);
                const rca = new THREE.Mesh(rcaGeometry, vesselMaterial);
                rca.name = 'rca';
                rca.userData = {
                    name: 'Right Coronary Artery',
                    diameter: '3-4mm',
                    origin: 'Right coronary sinus',
                    branches: 'Acute marginal, PDA (70%)',
                    territory: 'Inferior wall and RV'
                };
                parent.add(rca);
                
                // Add smaller branches with procedural generation
                this.createCoronaryBranches(parent, vesselMaterial);
            }

            createCoronaryBranches(parent, material) {
                // Diagonal branches from LAD
                for (let i = 0; i < 3; i++) {
                    const y = -1 - i * 1.5;
                    const curve = new THREE.CatmullRomCurve3([
                        new THREE.Vector3(-3.5, y, 4),
                        new THREE.Vector3(-4.5, y - 0.5, 3.5),
                        new THREE.Vector3(-5, y - 1, 2.5)
                    ]);
                    const geometry = new THREE.TubeGeometry(curve, 16, 0.08, 8, false);
                    const branch = new THREE.Mesh(geometry, material);
                    branch.name = `diagonal-${i + 1}`;
                    parent.add(branch);
                }
                
                // Septal perforators
                for (let i = 0; i < 4; i++) {
                    const y = -0.5 - i * 1;
                    const curve = new THREE.CatmullRomCurve3([
                        new THREE.Vector3(-3.5, y, 4),
                        new THREE.Vector3(-2.5, y, 3),
                        new THREE.Vector3(-1.5, y, 1)
                    ]);
                    const geometry = new THREE.TubeGeometry(curve, 16, 0.05, 8, false);
                    const branch = new THREE.Mesh(geometry, material);
                    branch.name = `septal-${i + 1}`;
                    parent.add(branch);
                }
            }

            createConductionSystem(parent) {
                const conductionMaterial = new THREE.MeshPhysicalMaterial({
                    color: 0xffcc00,
                    emissive: 0xffaa00,
                    emissiveIntensity: 0.3,
                    metalness: 0.2,
                    roughness: 0.3,
                    transparent: true,
                    opacity: 0.7
                });
                
                // SA Node
                const saNodeGeometry = new THREE.SphereGeometry(0.5, 32, 32);
                const saNode = new THREE.Mesh(saNodeGeometry, conductionMaterial);
                saNode.position.set(3.5, 5.5, 1);
                saNode.name = 'sa-node';
                saNode.userData = {
                    name: 'Sinoatrial Node',
                    rate: '60-100 bpm',
                    location: 'Junction of SVC and RA',
                    function: 'Primary pacemaker of the heart',
                    bloodSupply: 'RCA (60%) or LCX (40%)'
                };
                parent.add(saNode);
                
                // AV Node
                const avNodeGeometry = new THREE.SphereGeometry(0.4, 32, 32);
                const avNode = new THREE.Mesh(avNodeGeometry, conductionMaterial);
                avNode.position.set(0.5, 2, 0);
                avNode.name = 'av-node';
                avNode.userData = {
                    name: 'Atrioventricular Node',
                    rate: '40-60 bpm',
                    location: 'Koch triangle',
                    function: 'Delays conduction to ventricles',
                    bloodSupply: 'RCA (90%)'
                };
                parent.add(avNode);
                
                // Bundle of His
                const bundleCurve = new THREE.CatmullRomCurve3([
                    new THREE.Vector3(0.5, 2, 0),
                    new THREE.Vector3(0, 1, 0),
                    new THREE.Vector3(0, 0, 0),
                    new THREE.Vector3(0, -1, 0)
                ]);
                const bundleGeometry = new THREE.TubeGeometry(bundleCurve, 32, 0.15, 8, false);
                const bundleHis = new THREE.Mesh(bundleGeometry, conductionMaterial);
                bundleHis.name = 'bundle-his';
                bundleHis.userData = {
                    name: 'Bundle of His',
                    rate: '20-40 bpm',
                    location: 'Interventricular septum',
                    function: 'Rapid conduction to ventricles',
                    branches: 'Left and right bundle branches'
                };
                parent.add(bundleHis);
                
                // Bundle branches
                const leftBundleCurve = new THREE.CatmullRomCurve3([
                    new THREE.Vector3(0, -1, 0),
                    new THREE.Vector3(-1, -2, 0.5),
                    new THREE.Vector3(-2, -3, 1),
                    new THREE.Vector3(-3, -4, 1)
                ]);
                const leftBundleGeometry = new THREE.TubeGeometry(leftBundleCurve, 32, 0.1, 8, false);
                const leftBundle = new THREE.Mesh(leftBundleGeometry, conductionMaterial);
                leftBundle.name = 'left-bundle';
                parent.add(leftBundle);
                
                const rightBundleCurve = new THREE.CatmullRomCurve3([
                    new THREE.Vector3(0, -1, 0),
                    new THREE.Vector3(1, -2, 0.5),
                    new THREE.Vector3(2, -3, 1),
                    new THREE.Vector3(2.5, -4, 1.5)
                ]);
                const rightBundleGeometry = new THREE.TubeGeometry(rightBundleCurve, 32, 0.1, 8, false);
                const rightBundle = new THREE.Mesh(rightBundleGeometry, conductionMaterial);
                rightBundle.name = 'right-bundle';
                parent.add(rightBundle);
            }

            createBloodFlowSystem(parent) {
                // Create realistic blood flow particles
                const particleCount = 5000;
                const geometry = new THREE.BufferGeometry();
                const positions = new Float32Array(particleCount * 3);
                const colors = new Float32Array(particleCount * 3);
                const sizes = new Float32Array(particleCount);
                const velocities = new Float32Array(particleCount * 3);
                
                // Initialize particles in vessel paths
                for (let i = 0; i < particleCount; i++) {
                    const i3 = i * 3;
                    
                    // Distribute particles in circulatory paths
                    const angle = Math.random() * Math.PI * 2;
                    const radius = 2 + Math.random() * 8;
                    const height = (Math.random() - 0.5) * 10;
                    
                    positions[i3] = Math.cos(angle) * radius;
                    positions[i3 + 1] = height;
                    positions[i3 + 2] = Math.sin(angle) * radius;
                    
                    // Color based on oxygenation
                    const oxygenated = Math.random() > 0.5;
                    if (oxygenated) {
                        colors[i3] = 1;
                        colors[i3 + 1] = 0.2;
                        colors[i3 + 2] = 0.2;
                    } else {
                        colors[i3] = 0.4;
                        colors[i3 + 1] = 0;
                        colors[i3 + 2] = 0.1;
                    }
                    
                    sizes[i] = Math.random() * 0.3 + 0.1;
                    
                    // Random velocities
                    velocities[i3] = (Math.random() - 0.5) * 0.1;
                    velocities[i3 + 1] = (Math.random() - 0.5) * 0.1;
                    velocities[i3 + 2] = (Math.random() - 0.5) * 0.1;
                }
                
                geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
                geometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));
                geometry.setAttribute('velocity', new THREE.BufferAttribute(velocities, 3));
                
                const material = new THREE.PointsMaterial({
                    size: 0.2,
                    vertexColors: true,
                    transparent: true,
                    opacity: 0.8,
                    blending: THREE.AdditiveBlending,
                    depthWrite: false,
                    sizeAttenuation: true
                });
                
                const particles = new THREE.Points(geometry, material);
                particles.name = 'bloodFlow';
                particles.visible = false;
                parent.add(particles);
                
                this.particles.push({
                    system: particles,
                    velocities: velocities,
                    type: 'blood'
                });
            }

            createAnatomicalLabels(parent) {
                // 3D text labels for structures
                this.labels = [];
                
                Object.entries(this.structures).forEach(([key, structure]) => {
                    if (structure.userData && structure.userData.name) {
                        // Create label sprite
                        const canvas = document.createElement('canvas');
                        canvas.width = 256;
                        canvas.height = 64;
                        const context = canvas.getContext('2d');
                        
                        context.fillStyle = 'rgba(0, 0, 0, 0.8)';
                        context.fillRect(0, 0, 256, 64);
                        
                        context.font = 'Bold 24px Arial';
                        context.fillStyle = '#00d4ff';
                        context.textAlign = 'center';
                        context.textBaseline = 'middle';
                        context.fillText(structure.userData.name, 128, 32);
                        
                        const texture = new THREE.CanvasTexture(canvas);
                        const spriteMaterial = new THREE.SpriteMaterial({
                            map: texture,
                            transparent: true,
                            opacity: 0.9
                        });
                        
                        const sprite = new THREE.Sprite(spriteMaterial);
                        sprite.scale.set(4, 1, 1);
                        sprite.position.copy(structure.position);
                        sprite.position.y += 3;
                        sprite.visible = false;
                        sprite.name = `label-${key}`;
                        
                        parent.add(sprite);
                        this.labels.push(sprite);
                    }
                });
            }

            createBackgroundElements() {
                // Floating particles for depth
                const particleCount = 2000;
                const geometry = new THREE.BufferGeometry();
                const positions = new Float32Array(particleCount * 3);
                const colors = new Float32Array(particleCount * 3);
                
                for (let i = 0; i < particleCount; i++) {
                    const i3 = i * 3;
                    
                    positions[i3] = (Math.random() - 0.5) * 200;
                    positions[i3 + 1] = (Math.random() - 0.5) * 200;
                    positions[i3 + 2] = (Math.random() - 0.5) * 200;
                    
                    const color = Math.random();
                    colors[i3] = color * 0.5;
                    colors[i3 + 1] = color * 0.7;
                    colors[i3 + 2] = color;
                }
                
                geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
                
                const material = new THREE.PointsMaterial({
                    size: 0.5,
                    vertexColors: true,
                    transparent: true,
                    opacity: 0.3,
                    blending: THREE.AdditiveBlending,
                    sizeAttenuation: true
                });
                
                const particles = new THREE.Points(geometry, material);
                particles.name = 'backgroundParticles';
                this.scene.add(particles);
            }

            setupControls() {
                let isDragging = false;
                let previousMousePosition = { x: 0, y: 0 };
                
                const canvas = this.renderer.domElement;
                
                // Mouse controls
                canvas.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    previousMousePosition = { x: e.clientX, y: e.clientY };
                });
                
                canvas.addEventListener('mousemove', (e) => {
                    this.mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
                    this.mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
                    
                    if (isDragging && this.rotationEnabled) {
                        const deltaX = e.clientX - previousMousePosition.x;
                        const deltaY = e.clientY - previousMousePosition.y;
                        
                        if (this.heart) {
                            this.heart.rotation.y += deltaX * 0.005;
                            this.heart.rotation.x += deltaY * 0.005;
                        }
                        
                        previousMousePosition = { x: e.clientX, y: e.clientY };
                    }
                    
                    this.checkHover();
                });
                
                canvas.addEventListener('mouseup', () => {
                    isDragging = false;
                });
                
                canvas.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    const delta = e.deltaY * 0.05;
                    this.camera.position.z = Math.max(20, Math.min(60, this.camera.position.z + delta));
                });
                
                canvas.addEventListener('click', this.onStructureClick.bind(this));
                
                // Touch controls for mobile
                let touchStart = null;
                
                canvas.addEventListener('touchstart', (e) => {
                    touchStart = {
                        x: e.touches[0].clientX,
                        y: e.touches[0].clientY
                    };
                });
                
                canvas.addEventListener('touchmove', (e) => {
                    if (touchStart && this.rotationEnabled) {
                        const deltaX = e.touches[0].clientX - touchStart.x;
                        const deltaY = e.touches[0].clientY - touchStart.y;
                        
                        if (this.heart) {
                            this.heart.rotation.y += deltaX * 0.005;
                            this.heart.rotation.x += deltaY * 0.005;
                        }
                        
                        touchStart = {
                            x: e.touches[0].clientX,
                            y: e.touches[0].clientY
                        };
                    }
                });
                
                canvas.addEventListener('touchend', () => {
                    touchStart = null;
                });
            }

            checkHover() {
                this.raycaster.setFromCamera(this.mouse, this.camera);
                const intersects = this.raycaster.intersectObjects(Object.values(this.structures));
                
                // Reset all materials
                Object.values(this.structures).forEach(structure => {
                    if (structure.material && structure !== this.selectedStructure) {
                        structure.material.emissiveIntensity = 0.02;
                    }
                });
                
                if (intersects.length > 0) {
                    const hoveredObject = intersects[0].object;
                    if (hoveredObject.material) {
                        hoveredObject.material.emissiveIntensity = 0.1;
                        this.hoveredStructure = hoveredObject;
                    }
                    
                    // Show tooltip
                    const tooltip = document.getElementById('tooltip');
                    if (hoveredObject.userData && hoveredObject.userData.name) {
                        tooltip.querySelector('.tooltip-header').textContent = hoveredObject.userData.name;
                        tooltip.querySelector('.tooltip-body').textContent = 
                            hoveredObject.userData.function ? 
                            hoveredObject.userData.function.substring(0, 100) + '...' : 
                            'Click for details';
                        tooltip.classList.add('visible');
                        
                        // Position tooltip
                        const vector = hoveredObject.position.clone();
                        vector.project(this.camera);
                        
                        const x = (vector.x * 0.5 + 0.5) * window.innerWidth;
                        const y = (-vector.y * 0.5 + 0.5) * window.innerHeight;
                        
                        tooltip.style.left = `${x + 10}px`;
                        tooltip.style.top = `${y - 50}px`;
                    }
                    
                    document.body.style.cursor = 'pointer';
                } else {
                    this.hoveredStructure = null;
                    document.getElementById('tooltip').classList.remove('visible');
                    document.body.style.cursor = 'default';
                }
            }

            onStructureClick(event) {
                this.raycaster.setFromCamera(this.mouse, this.camera);
                const intersects = this.raycaster.intersectObjects(Object.values(this.structures));
                
                if (intersects.length > 0) {
                    const clickedObject = intersects[0].object;
                    this.selectStructure(clickedObject.name);
                }
            }

            selectStructure(structureName) {
                // Update UI selection
                document.querySelectorAll('.structure-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                const selectedItem = document.querySelector(`[data-structure="${structureName}"]`);
                if (selectedItem) {
                    selectedItem.classList.add('active');
                }
                
                // Update structure highlighting
                if (this.selectedStructure) {
                    this.selectedStructure.material.emissiveIntensity = 0.02;
                }
                
                const structure = this.structures[structureName];
                if (structure) {
                    this.selectedStructure = structure;
                    structure.material.emissiveIntensity = 0.15;
                    
                    // Update info panel with detailed data
                    this.updateInfoPanel(structure.userData);
                    
                    // Animate camera to focus on structure
                    this.focusOnStructure(structure);
                    
                    // Show notification
                    this.showNotification(
                        `Selected: ${structure.userData.name}`,
                        'View detailed information in the right panel',
                        'info'
                    );
                }
            }

            updateInfoPanel(data) {
                if (!data) return;
                
                // Update title
                document.getElementById('infoTitle').textContent = data.name || 'Structure Information';
                document.getElementById('infoSubtitle').textContent = 'Comprehensive anatomical analysis';
                
                // Update anatomical measurements
                if (data.wallThickness) {
                    document.getElementById('wallThickness').textContent = data.wallThickness.value;
                }
                if (data.volume) {
                    document.getElementById('chamberVolume').textContent = 
                        `${data.volume.min}-${data.volume.max}`;
                }
                if (data.pressure) {
                    document.getElementById('pressure').textContent = 
                        data.pressure.systolic ? 
                        `${data.pressure.systolic}/${data.pressure.diastolic}` : 
                        data.pressure.mean || '--';
                }
                if (data.area) {
                    document.getElementById('flowRate').textContent = data.area.value;
                }
                
                // Update physiology section
                const physiologyInfo = document.getElementById('physiologyInfo');
                physiologyInfo.innerHTML = `
                    <h4 style="color: var(--accent-blue); margin-bottom: 10px;">Physiological Function</h4>
                    <p style="line-height: 1.8; margin-bottom: 15px;">${data.function || 'No data available'}</p>
                    ${data.bloodSupply ? `<p><strong>Blood Supply:</strong> ${data.bloodSupply}</p>` : ''}
                    ${data.innervation ? `<p><strong>Innervation:</strong> ${data.innervation}</p>` : ''}
                `;
                
                // Update clinical section
                const clinicalInfo = document.getElementById('clinicalInfo');
                clinicalInfo.innerHTML = `
                    <h4 style="color: var(--accent-purple); margin-bottom: 10px;">Clinical Significance</h4>
                    <p style="line-height: 1.8;">${data.clinical || 'No clinical data available'}</p>
                `;
                
                // Update surgical section
                const surgicalInfo = document.getElementById('surgicalInfo');
                surgicalInfo.innerHTML = `
                    <h4 style="color: var(--success-green); margin-bottom: 10px;">Surgical Considerations</h4>
                    <p style="line-height: 1.8;">${data.surgical || 'No surgical data available'}</p>
                `;
            }

            focusOnStructure(structure) {
                const targetPosition = structure.position.clone();
                
                // Calculate optimal camera position
                const distance = 15;
                const angle = Date.now() * 0.0001;
                const targetCameraPosition = new THREE.Vector3(
                    targetPosition.x + Math.sin(angle) * distance,
                    targetPosition.y + 5,
                    targetPosition.z + Math.cos(angle) * distance
                );
                
                // Animate camera movement
                new TWEEN.Tween(this.camera.position)
                    .to(targetCameraPosition, 1500)
                    .easing(TWEEN.Easing.Quadratic.InOut)
                    .start();
                
                // Update camera look-at
                new TWEEN.Tween(this.camera)
                    .to({}, 1500)
                    .onUpdate(() => {
                        this.camera.lookAt(targetPosition);
                    })
                    .start();
            }

            setupEventListeners() {
                // Window resize
                window.addEventListener('resize', () => {
                    this.camera.aspect = window.innerWidth / window.innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    switch(e.key) {
                        case 'r':
                        case 'R':
                            this.toggleRotation();
                            break;
                        case 'x':
                        case 'X':
                            this.toggleXray();
                            break;
                        case 'b':
                        case 'B':
                            this.toggleBloodFlow();
                            break;
                        case 'l':
                        case 'L':
                            this.toggleLabels();
                            break;
                        case 'Escape':
                            this.exitCurrentMode();
                            break;
                        case ' ':
                            e.preventDefault();
                            this.resetView();
                            break;
                    }
                });
                
                // Structure list clicks
                document.querySelectorAll('.structure-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const structureName = item.dataset.structure;
                        this.selectStructure(structureName);
                    });
                });
                
                // Search functionality
                document.getElementById('anatomySearch').addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    document.querySelectorAll('.structure-item').forEach(item => {
                        const name = item.querySelector('.structure-name').textContent.toLowerCase();
                        const parent = item.closest('.category-section');
                        
                        if (name.includes(searchTerm)) {
                            item.style.display = 'flex';
                            if (parent && !parent.classList.contains('expanded')) {
                                parent.classList.add('expanded');
                            }
                        } else {
                            item.style.display = searchTerm === '' ? 'flex' : 'none';
                        }
                    });
                });
            }

            initializeUI() {
                // Initialize learning modules
                this.initializeLearningModules();
                
                // Initialize assessment questions
                this.initializeAssessment();
                
                // Setup ECG animation
                this.setupECGAnimation();
                
                // Initialize metrics
                this.updateMetrics();
                
                // Setup notification system
                this.setupNotifications();
            }

            initializeLearningModules() {
                const modulesContainer = document.getElementById('learningModules');
                if (!modulesContainer) return;
                
                this.learningModules.forEach((module, index) => {
                    const moduleElement = document.createElement('div');
                    moduleElement.className = 'module-item';
                    moduleElement.innerHTML = `
                        <div class="module-number">${index + 1}</div>
                        <div class="module-info">
                            <div class="module-title">${module.title}</div>
                            <div class="module-duration">${module.duration}</div>
                        </div>
                        <div class="module-status"></div>
                    `;
                    
                    moduleElement.addEventListener('click', () => {
                        this.startLearningModule(index);
                    });
                    
                    modulesContainer.appendChild(moduleElement);
                });
            }

            generateLearningModules() {
                return [
                    {
                        title: 'Introduction to Cardiac Anatomy',
                        duration: '10 minutes',
                        lessons: [
                            {
                                title: 'Overview of the Cardiovascular System',
                                content: `
                                    <p>The cardiovascular system is a closed-loop system consisting of the heart, blood vessels, and approximately 5 liters of blood. The heart functions as a dual pump, with the right side handling pulmonary circulation and the left side managing systemic circulation.</p>
                                    
                                    <div class="lesson-important">
                                        <div class="lesson-important-title">Key Concepts</div>
                                        <p>The heart beats approximately 100,000 times per day, pumping about 7,500 liters of blood. This remarkable organ weighs only 250-350 grams but is responsible for delivering oxygen and nutrients to every cell in your body.</p>
                                    </div>
                                    
                                    <h3>Embryological Development</h3>
                                    <p>The heart begins development at week 3 of gestation from the mesoderm. The primitive heart tube undergoes complex looping and septation to form the four-chambered heart by week 8.</p>
                                    
                                    <ul class="lesson-list">
                                        <li>Day 21: Heart tube formation begins</li>
                                        <li>Day 28: Heart begins beating</li>
                                        <li>Week 4-5: Cardiac looping occurs</li>
                                        <li>Week 5-8: Septation of chambers</li>
                                        <li>Week 8: Four-chambered heart complete</li>
                                    </ul>
                                `,
                                structure: null
                            }
                        ]
                    },
                    {
                        title: 'Cardiac Chambers - Atria',
                        duration: '15 minutes',
                        lessons: [
                            {
                                title: 'Left Atrium - Anatomical Details',
                                content: `
                                    <p>The left atrium is a thin-walled chamber that receives oxygenated blood from the four pulmonary veins. It has distinct anatomical regions with clinical significance.</p>
                                    
                                    <h3>Anatomical Regions</h3>
                                    <ul class="lesson-list">
                                        <li><strong>Posterior Wall:</strong> Smooth-walled, derived from pulmonary veins incorporation</li>
                                        <li><strong>Left Atrial Appendage (LAA):</strong> Trabeculated, finger-like projection, common site for thrombus</li>
                                        <li><strong>Interatrial Septum:</strong> Contains fossa ovalis, remnant of foramen ovale</li>
                                        <li><strong>Mitral Valve Annulus:</strong> Fibrous ring supporting mitral valve</li>
                                    </ul>
                                    
                                    <div class="lesson-important">
                                        <div class="lesson-important-title">Clinical Pearl</div>
                                        <p>The LAA is responsible for 90% of thrombi in non-valvular atrial fibrillation. LAA occlusion devices (Watchman) can reduce stroke risk by 84%.</p>
                                    </div>
                                    
                                    <h3>Physiological Parameters</h3>
                                    <p>Normal LA pressure: 8-12 mmHg<br>
                                    Normal LA volume: 40-65 mL<br>
                                    LA ejection fraction: 45-65%</p>
                                `,
                                structure: 'left-atrium'
                            },
                            {
                                title: 'Right Atrium - Functional Anatomy',
                                content: `
                                    <p>The right atrium receives systemic venous return and contains the cardiac conduction system's primary pacemaker.</p>
                                    
                                    <h3>Important Landmarks</h3>
                                    <ul class="lesson-list">
                                        <li><strong>Crista Terminalis:</strong> Ridge separating smooth and trabeculated portions</li>
                                        <li><strong>Sinoatrial Node:</strong> Located at SVC-RA junction</li>
                                        <li><strong>Koch's Triangle:</strong> Contains AV node, bordered by coronary sinus, septal leaflet, and tendon of Todaro</li>
                                        <li><strong>Eustachian Valve:</strong> Remnant directing IVC flow in fetus</li>
                                        <li><strong>Thebesian Valve:</strong> Guards coronary sinus ostium</li>
                                    </ul>
                                    
                                    <div class="lesson-important">
                                        <div class="lesson-important-title">Surgical Consideration</div>
                                        <p>During cannulation for CPB, avoid the SA node region (10-11 o'clock position relative to SVC). Injury can cause sick sinus syndrome requiring permanent pacemaker.</p>
                                    </div>
                                `,
                                structure: 'right-atrium'
                            }
                        ]
                    },
                    {
                        title: 'Cardiac Chambers - Ventricles',
                        duration: '20 minutes',
                        lessons: [
                            {
                                title: 'Left Ventricle - The Systemic Pump',
                                content: `
                                    <p>The left ventricle is the heart's powerhouse, generating pressures up to 120 mmHg to perfuse the entire systemic circulation.</p>
                                    
                                    <h3>Wall Segments (17-Segment Model)</h3>
                                    <p>The American Heart Association 17-segment model divides the LV into:</p>
                                    <ul class="lesson-list">
                                        <li><strong>Basal Level (6 segments):</strong> Anterior, anteroseptal, inferoseptal, inferior, inferolateral, anterolateral</li>
                                        <li><strong>Mid Level (6 segments):</strong> Same distribution as basal</li>
                                        <li><strong>Apical Level (4 segments):</strong> Anterior, septal, inferior, lateral</li>
                                        <li><strong>Apex (1 segment):</strong> True apex</li>
                                    </ul>
                                    
                                    <h3>Coronary Supply by Segment</h3>
                                    <p><span class="lesson-highlight">LAD Territory:</span> Anterior, anteroseptal, apical segments<br>
                                    <span class="lesson-highlight">LCX Territory:</span> Lateral and inferolateral segments<br>
                                    <span class="lesson-highlight">RCA Territory:</span> Inferior and inferoseptal segments</p>
                                    
                                    <div class="lesson-important">
                                        <div class="lesson-important-title">Clinical Application</div>
                                        <p>Wall motion abnormalities on echo correspond to coronary territories. Akinesis in anterior/anteroseptal segments suggests LAD occlusion.</p>
                                    </div>
                                `,
                                structure: 'left-ventricle'
                            }
                        ]
                    },
                    {
                        title: 'Cardiac Valves - Atrioventricular',
                        duration: '25 minutes',
                        lessons: [
                            {
                                title: 'Mitral Valve - Complex Apparatus',
                                content: `
                                    <p>The mitral valve is a complex structure with multiple components working in concert to prevent regurgitation.</p>
                                    
                                    <h3>Anatomical Components</h3>
                                    <ul class="lesson-list">
                                        <li><strong>Anterior Leaflet (A):</strong> Larger surface area, 1/3 of annular circumference</li>
                                        <li><strong>Posterior Leaflet (P):</strong> Smaller area, 2/3 of annular circumference</li>
                                        <li><strong>Commissures:</strong> Anterolateral and posteromedial</li>
                                        <li><strong>Chordae Tendineae:</strong> Primary (free edge), secondary (body), tertiary (basal)</li>
                                        <li><strong>Papillary Muscles:</strong> Anterolateral (dual blood supply) and posteromedial (single supply - vulnerable)</li>
                                    </ul>
                                    
                                    <h3>Carpentier Classification</h3>
                                    <p>Leaflets divided into segments:</p>
                                    <ul class="lesson-list">
                                        <li>Anterior: A1 (lateral), A2 (middle), A3 (medial)</li>
                                        <li>Posterior: P1 (lateral), P2 (middle), P3 (medial)</li>
                                    </ul>
                                    
                                    <div class="lesson-important">
                                        <div class="lesson-important-title">Surgical Technique</div>
                                        <p>P2 prolapse is most common (40%). Repair techniques include: triangular/quadrangular resection, neochordae, edge-to-edge repair (Alfieri), annuloplasty ring.</p>
                                    </div>
                                `,
                                structure: 'mitral-valve'
                            }
                        ]
                    },
                    {
                        title: 'Coronary Circulation',
                        duration: '30 minutes',
                        lessons: [
                            {
                                title: 'Coronary Anatomy and Territories',
                                content: `
                                    <p>The coronary circulation supplies the myocardium with oxygen and nutrients. Understanding coronary anatomy is crucial for interpreting angiography and planning interventions.</p>
                                    
                                    <h3>Left Coronary System</h3>
                                    <ul class="lesson-list">
                                        <li><strong>Left Main (LMCA):</strong> 5-10mm length, bifurcates into LAD and LCX</li>
                                        <li><strong>LAD Branches:</strong> Diagonals (D1, D2), Septals (S1, S2)</li>
                                        <li><strong>LCX Branches:</strong> Obtuse marginals (OM1, OM2), Left PDA (15%)</li>
                                    </ul>
                                    
                                    <h3>Right Coronary System</h3>
                                    <ul class="lesson-list">
                                        <li><strong>Proximal RCA:</strong> Conus branch, SA nodal artery (60%)</li>
                                        <li><strong>Mid RCA:</strong> Acute marginal branches</li>
                                        <li><strong>Distal RCA:</strong> PDA (85%), AV nodal artery, PLV</li>
                                    </ul>
                                    
                                    <h3>Dominance Patterns</h3>
                                    <p><span class="lesson-highlight">Right Dominant (70%):</span> RCA gives PDA and PLV<br>
                                    <span class="lesson-highlight">Left Dominant (10%):</span> LCX gives PDA and PLV<br>
                                    <span class="lesson-highlight">Co-dominant (20%):</span> RCA gives PDA, LCX gives PLV</p>
                                    
                                    <div class="lesson-important">
                                        <div class="lesson-important-title">Clinical Correlation</div>
                                        <p>Left main disease ("widow maker") affects 70% of myocardium. >50% stenosis is indication for urgent CABG. Protected left main has patent grafts to LAD/LCX.</p>
                                    </div>
                                `,
                                structure: 'lad'
                            }
                        ]
                    },
                    {
                        title: 'Conduction System',
                        duration: '15 minutes',
                        lessons: [
                            {
                                title: 'Electrical Pathways of the Heart',
                                content: `
                                    <p>The cardiac conduction system coordinates synchronized contraction of the heart chambers.</p>
                                    
                                    <h3>Components and Timing</h3>
                                    <ul class="lesson-list">
                                        <li><strong>SA Node:</strong> 60-100 bpm, P wave generation</li>
                                        <li><strong>Internodal Pathways:</strong> Anterior (Bachmann), Middle (Wenckebach), Posterior (Thorel)</li>
                                        <li><strong>AV Node:</strong> 40-60 bpm, PR interval delay (0.12-0.20s)</li>
                                        <li><strong>Bundle of His:</strong> Penetrates central fibrous body</li>
                                        <li><strong>Bundle Branches:</strong> Right (single), Left (LAF, LPF)</li>
                                        <li><strong>Purkinje Fibers:</strong> 20-40 bpm, rapid ventricular activation</li>
                                    </ul>
                                    
                                    <h3>ECG Correlation</h3>
                                    <p>P wave: Atrial depolarization<br>
                                    PR interval: AV conduction time<br>
                                    QRS complex: Ventricular depolarization<br>
                                    T wave: Ventricular repolarization</p>
                                    
                                    <div class="lesson-important">
                                        <div class="lesson-important-title">Surgical Hazard</div>
                                        <p>AV node lies in Koch's triangle. During tricuspid surgery, stay >5mm from coronary sinus os. His bundle penetrates at apex of triangle - avoid deep sutures here.</p>
                                    </div>
                                `,
                                structure: 'sa-node'
                            }
                        ]
                    }
                ];
            }

            startLearningModule(moduleIndex) {
                this.currentModule = moduleIndex;
                this.currentLesson = 0;
                
                const module = this.learningModules[moduleIndex];
                const learningInterface = document.getElementById('learningInterface');
                learningInterface.classList.add('active');
                
                // Update module list UI
                document.querySelectorAll('.module-item').forEach((item, index) => {
                    item.classList.remove('active');
                    if (index === moduleIndex) {
                        item.classList.add('active');
                    }
                });
                
                this.showLesson(module.lessons[0]);
                this.updateLearningProgress();
            }

            showLesson(lesson) {
                const contentContainer = document.getElementById('learningContent');
                
                contentContainer.innerHTML = `
                    <div class="lesson-header">
                        <h2 class="lesson-title">${lesson.title}</h2>
                        <p class="lesson-subtitle">Interactive learning experience with 3D visualization</p>
                    </div>
                    <div class="lesson-body">
                        ${lesson.content}
                    </div>
                    <div class="lesson-actions">
                        <button class="lesson-btn" onclick="cardioSim.previousLesson()">
                            <span>←</span> Previous
                        </button>
                        <button class="lesson-btn" onclick="cardioSim.exitLearning()">
                            Exit Learning
                        </button>
                        <button class="lesson-btn primary" onclick="cardioSim.nextLesson()">
                            Next <span>→</span>
                        </button>
                    </div>
                `;
                
                // Focus on relevant structure
                if (lesson.structure) {
                    this.selectStructure(lesson.structure);
                }
            }

            nextLesson() {
                const module = this.learningModules[this.currentModule];
                if (this.currentLesson < module.lessons.length - 1) {
                    this.currentLesson++;
                    this.showLesson(module.lessons[this.currentLesson]);
                } else if (this.currentModule < this.learningModules.length - 1) {
                    this.startLearningModule(this.currentModule + 1);
                } else {
                    this.completeLearning();
                }
                this.updateLearningProgress();
            }

            previousLesson() {
                if (this.currentLesson > 0) {
                    this.currentLesson--;
                    const module = this.learningModules[this.currentModule];
                    this.showLesson(module.lessons[this.currentLesson]);
                } else if (this.currentModule > 0) {
                    this.currentModule--;
                    const prevModule = this.learningModules[this.currentModule];
                    this.currentLesson = prevModule.lessons.length - 1;
                    this.showLesson(prevModule.lessons[this.currentLesson]);
                }
                this.updateLearningProgress();
            }

            exitLearning() {
                document.getElementById('learningInterface').classList.remove('active');
                this.mode = 'explore';
                this.updateModeUI();
            }

            completeLearning() {
                this.completedModules.push(this.currentModule);
                this.showNotification(
                    'Module Completed!',
                    `You've completed ${this.learningModules[this.currentModule].title}`,
                    'success'
                );
                this.exitLearning();
            }

            updateLearningProgress() {
                const totalLessons = this.learningModules.reduce((sum, module) => 
                    sum + module.lessons.length, 0);
                const completedLessons = this.learningModules.slice(0, this.currentModule)
                    .reduce((sum, module) => sum + module.lessons.length, 0) + this.currentLesson + 1;
                
                const percentage = Math.round((completedLessons / totalLessons) * 100);
                
                document.getElementById('progressPercentage').textContent = `${percentage}%`;
                document.getElementById('progressFill').style.width = `${percentage}%`;
            }

            generateAssessmentQuestions() {
                return [
                    {
                        question: 'Which coronary artery is known as the "widow maker"?',
                        options: [
                            'Right Coronary Artery',
                            'Left Anterior Descending Artery',
                            'Left Circumflex Artery',
                            'Posterior Descending Artery'
                        ],
                        correct: 1,
                        explanation: 'The Left Anterior Descending (LAD) artery is called the "widow maker" because occlusion can cause massive anterior wall MI affecting a large portion of the left ventricle, often resulting in sudden death.'
                    },
                    {
                        question: 'What is the normal ejection fraction of the left ventricle?',
                        options: [
                            '25-35%',
                            '40-50%',
                            '55-70%',
                            '75-85%'
                        ],
                        correct: 2,
                        explanation: 'Normal left ventricular ejection fraction is 55-70%. Below 40% indicates systolic dysfunction, while >70% may suggest hyperdynamic state or measurement error.'
                    },
                    {
                        question: 'In Carpentier\'s classification, which segment is most commonly affected in mitral valve prolapse?',
                        options: [
                            'A1 - Anterior lateral',
                            'A2 - Anterior middle',
                            'P1 - Posterior lateral',
                            'P2 - Posterior middle'
                        ],
                        correct: 3,
                        explanation: 'P2 (posterior middle) segment prolapse accounts for approximately 40% of all mitral valve prolapse cases, making it the most common site for pathology.'
                    },
                    {
                        question: 'What percentage of patients have right-dominant coronary circulation?',
                        options: [
                            '30%',
                            '50%',
                            '70%',
                            '90%'
                        ],
                        correct: 2,
                        explanation: 'Approximately 70% of patients have right-dominant coronary circulation, where the RCA supplies the PDA and PLV. 10% are left-dominant, and 20% are co-dominant.'
                    },
                    {
                        question: 'Where is Koch\'s triangle located and what is its clinical significance?',
                        options: [
                            'Left atrium - Contains mitral valve',
                            'Right atrium - Contains AV node',
                            'Left ventricle - Contains papillary muscles',
                            'Right ventricle - Contains moderator band'
                        ],
                        correct: 1,
                        explanation: 'Koch\'s triangle is located in the right atrium, bordered by the coronary sinus, septal tricuspid leaflet, and tendon of Todaro. It contains the AV node and is a critical landmark during electrophysiology procedures.'
                    }
                ];
            }

            initializeAssessment() {
                // Assessment initialization handled when mode is activated
            }

            startAssessment() {
                this.mode = 'assess';
                this.currentQuestion = 0;
                this.assessmentScore = 0;
                
                const assessmentInterface = document.getElementById('assessmentInterface');
                assessmentInterface.classList.add('active');
                
                this.showQuestion(0);
            }

            showQuestion(questionIndex) {
                const question = this.assessmentQuestions[questionIndex];
                const container = document.querySelector('.assessment-container');
                
                container.innerHTML = `
                    <div class="quiz-header">
                        <h2 class="quiz-title">Cardiac Anatomy Assessment</h2>
                        <div class="quiz-progress-info">
                            <div class="quiz-stat">
                                <span class="quiz-stat-label">Question</span>
                                <span class="quiz-stat-value">${questionIndex + 1}/${this.assessmentQuestions.length}</span>
                            </div>
                            <div class="quiz-stat">
                                <span class="quiz-stat-label">Score</span>
                                <span class="quiz-stat-value">${this.assessmentScore}/${questionIndex}</span>
                            </div>
                        </div>
                        <div class="quiz-progress-bar">
                            <div class="quiz-progress-fill" style="width: ${((questionIndex + 1) / this.assessmentQuestions.length) * 100}%"></div>
                        </div>
                    </div>
                    <div class="quiz-question-container">
                        <div class="quiz-question">${question.question}</div>
                        <div class="quiz-options" id="quizOptions">
                            ${question.options.map((option, index) => `
                                <div class="quiz-option" onclick="cardioSim.selectAnswer(${index})">
                                    <div class="option-indicator">${String.fromCharCode(65 + index)}</div>
                                    <div class="option-content">
                                        <div class="option-text">${option}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="quiz-explanation" id="quizExplanation">
                            <div class="explanation-header">
                                <div class="explanation-icon correct">✓</div>
                                <div class="explanation-title">Explanation</div>
                            </div>
                            <div class="explanation-text">${question.explanation}</div>
                        </div>
                    </div>
                    <div class="quiz-actions">
                        <button class="lesson-btn" onclick="cardioSim.exitAssessment()">Exit Assessment</button>
                        <button class="lesson-btn primary" onclick="cardioSim.nextQuestion()" id="nextQuestionBtn" style="display: none;">Next Question</button>
                    </div>
                `;
            }

            selectAnswer(answerIndex) {
                const question = this.assessmentQuestions[this.currentQuestion];
                const options = document.querySelectorAll('.quiz-option');
                
                // Disable all options
                options.forEach(option => {
                    option.style.pointerEvents = 'none';
                });
                
                // Mark selected answer
                options[answerIndex].classList.add('selected');
                
                // Show correct/incorrect
                setTimeout(() => {
                    if (answerIndex === question.correct) {
                        options[answerIndex].classList.add('correct');
                        this.assessmentScore++;
                        this.showNotification('Correct!', 'Great job!', 'success');
                    } else {
                        options[answerIndex].classList.add('incorrect');
                        options[question.correct].classList.add('correct');
                        this.showNotification('Incorrect', 'Review the explanation', 'warning');
                    }
                    
                    // Show explanation
                    document.getElementById('quizExplanation').classList.add('show');
                    document.getElementById('nextQuestionBtn').style.display = 'block';
                }, 500);
            }

            nextQuestion() {
                if (this.currentQuestion < this.assessmentQuestions.length - 1) {
                    this.currentQuestion++;
                    this.showQuestion(this.currentQuestion);
                } else {
                    this.completeAssessment();
                }
            }

            completeAssessment() {
                const percentage = Math.round((this.assessmentScore / this.assessmentQuestions.length) * 100);
                const container = document.querySelector('.assessment-container');
                
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <h2 style="font-size: 36px; margin-bottom: 20px; background: linear-gradient(135deg, #00d4ff, #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                            Assessment Complete!
                        </h2>
                        <div style="font-size: 72px; font-weight: bold; color: ${percentage >= 80 ? '#10b981' : percentage >= 60 ? '#f59e0b' : '#ef4444'}; margin: 30px 0;">
                            ${percentage}%
                        </div>
                        <p style="font-size: 20px; color: var(--text-secondary); margin-bottom: 40px;">
                            You scored ${this.assessmentScore} out of ${this.assessmentQuestions.length} questions correctly
                        </p>
                        <button class="lesson-btn primary" onclick="cardioSim.exitAssessment()" style="margin: 0 auto;">
                            Continue Training
                        </button>
                    </div>
                `;
                
                this.showNotification(
                    'Assessment Complete',
                    `Your score: ${percentage}%`,
                    percentage >= 80 ? 'success' : 'info'
                );
            }

            exitAssessment() {
                document.getElementById('assessmentInterface').classList.remove('active');
                this.mode = 'explore';
                this.updateModeUI();
            }

            setupECGAnimation() {
                const path = document.getElementById('ecgPath');
                if (!path) return;
                
                let x = 0;
                const ecgWave = () => {
                    x += 2;
                    if (x > 300) x = 0;
                    
                    const d = `M0,30 L${x-60},30 L${x-50},30 L${x-40},25 L${x-30},35 L${x-20},30 L${x-10},30 L${x},10 L${x+10},50 L${x+20},30 L${x+30},30 L300,30`;
                    path.setAttribute('d', d);
                    
                    requestAnimationFrame(ecgWave);
                };
                ecgWave();
            }

            updateMetrics() {
                // Simulate realistic vital signs
                setInterval(() => {
                    // Heart rate variation
                    const baseHR = 72;
                    const variation = Math.sin(Date.now() * 0.001) * 5 + Math.random() * 3;
                    document.getElementById('heartRate').textContent = Math.round(baseHR + variation);
                    
                    // Blood pressure occasional update
                    if (Math.random() < 0.1) {
                        const systolic = 115 + Math.random() * 10;
                        const diastolic = 75 + Math.random() * 10;
                        document.getElementById('bloodPressure').textContent = 
                            `${Math.round(systolic)}/${Math.round(diastolic)}`;
                    }
                    
                    // O2 saturation
                    const o2 = 97 + Math.random() * 2;
                    document.getElementById('oxygenSat').textContent = Math.round(o2);
                    
                    // Cardiac output
                    const co = 5.0 + Math.random() * 0.4;
                    document.getElementById('cardiacOutput').textContent = co.toFixed(1);
                }, 1000);
            }

            setupNotifications() {
                // Auto-hide notifications after 5 seconds
                this.notificationTimeout = null;
            }

            showNotification(title, message, type = 'info') {
                const notification = document.getElementById('notification');
                const icon = notification.querySelector('.notification-icon');
                const titleEl = notification.querySelector('.notification-title');
                const messageEl = notification.querySelector('.notification-message');
                
                // Update content
                titleEl.textContent = title;
                messageEl.textContent = message;
                
                // Update icon based on type
                icon.className = `notification-icon ${type}`;
                const icons = {
                    success: '✓',
                    info: 'ℹ️',
                    warning: '⚠️',
                    error: '❌'
                };
                icon.textContent = icons[type] || icons.info;
                
                // Show notification
                notification.classList.add('show');
                
                // Clear previous timeout
                if (this.notificationTimeout) {
                    clearTimeout(this.notificationTimeout);
                }
                
                // Auto-hide after 5 seconds
                this.notificationTimeout = setTimeout(() => {
                    notification.classList.remove('show');
                }, 5000);
            }

            updateModeUI() {
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`.mode-btn[onclick*="${this.mode}"]`)?.classList.add('active');
            }

            animate() {
                requestAnimationFrame(this.animate.bind(this));
                
                this.animationFrame++;
                
                // Update tweens
                TWEEN.update();
                
                // Heartbeat animation
                if (this.heart) {
                    this.heartbeatPhase += 0.02;
                    const scale = 1 + Math.sin(this.heartbeatPhase) * 0.02;
                    this.heart.scale.set(scale, scale, scale);
                    
                    // Auto-rotation in explore mode
                    if (this.rotationEnabled && this.mode === 'explore' && !this.selectedStructure) {
                        this.heart.rotation.y += 0.001;
                    }
                }
                
                // Blood flow animation
                if (this.bloodFlowEnabled && this.particles.length > 0) {
                    this.particles.forEach(particleData => {
                        const positions = particleData.system.geometry.attributes.position;
                        const velocities = particleData.velocities;
                        
                        for (let i = 0; i < positions.count; i++) {
                            const i3 = i * 3;
                            
                            // Update positions based on velocities
                            positions.array[i3] += velocities[i3];
                            positions.array[i3 + 1] += velocities[i3 + 1] - 0.02; // Gravity
                            positions.array[i3 + 2] += velocities[i3 + 2];
                            
                            // Wrap around
                            if (positions.array[i3 + 1] < -10) {
                                positions.array[i3 + 1] = 10;
                                velocities[i3] = (Math.random() - 0.5) * 0.1;
                                velocities[i3 + 1] = (Math.random() - 0.5) * 0.1;
                                velocities[i3 + 2] = (Math.random() - 0.5) * 0.1;
                            }
                        }
                        
                        positions.needsUpdate = true;
                        particleData.system.rotation.y += 0.001;
                    });
                }
                
                // Background particles animation
                const bgParticles = this.scene.getObjectByName('backgroundParticles');
                if (bgParticles) {
                    bgParticles.rotation.y += 0.0001;
                    bgParticles.rotation.x += 0.0001;
                }
                
                // Render scene
                this.renderer.render(this.scene, this.camera);
            }

            // Control functions
            toggleRotation() {
                this.rotationEnabled = !this.rotationEnabled;
                document.getElementById('rotateBtn').classList.toggle('active');
                this.showNotification(
                    'Rotation ' + (this.rotationEnabled ? 'Enabled' : 'Disabled'),
                    'Use mouse to rotate the model',
                    'info'
                );
            }

            toggleCrosssection() {
                this.crossSectionEnabled = !this.crossSectionEnabled;
                document.getElementById('crossBtn').classList.toggle('active');
                
                // Implement cross-section logic
                if (this.crossSectionEnabled) {
                    // Add clipping plane
                    const plane = new THREE.Plane(new THREE.Vector3(0, -1, 0), 0);
                    this.renderer.clippingPlanes = [plane];
                } else {
                    this.renderer.clippingPlanes = [];
                }
                
                this.showNotification(
                    'Cross-Section ' + (this.crossSectionEnabled ? 'Enabled' : 'Disabled'),
                    'View internal structures',
                    'info'
                );
            }

            toggleXray() {
                this.xrayMode = !this.xrayMode;
                document.getElementById('xrayBtn').classList.toggle('active');
                
                Object.values(this.structures).forEach(structure => {
                    if (structure.material) {
                        structure.material.opacity = this.xrayMode ? 0.3 : 0.95;
                        structure.material.depthWrite = !this.xrayMode;
                    }
                });
                
                this.showNotification(
                    'X-Ray Mode ' + (this.xrayMode ? 'Enabled' : 'Disabled'),
                    'See through structures',
                    'info'
                );
            }

            toggleBloodFlow() {
                this.bloodFlowEnabled = !this.bloodFlowEnabled;
                document.getElementById('flowBtn').classList.toggle('active');
                
                this.particles.forEach(particleData => {
                    particleData.system.visible = this.bloodFlowEnabled;
                });
                
                this.showNotification(
                    'Blood Flow ' + (this.bloodFlowEnabled ? 'Enabled' : 'Disabled'),
                    'Visualize circulation patterns',
                    'info'
                );
            }

            toggleLabels() {
                this.labelsEnabled = !this.labelsEnabled;
                document.getElementById('labelsBtn').classList.toggle('active');
                
                this.labels.forEach(label => {
                    label.visible = this.labelsEnabled;
                });
                
                this.showNotification(
                    'Labels ' + (this.labelsEnabled ? 'Shown' : 'Hidden'),
                    'Anatomical structure names',
                    'info'
                );
            }

            resetView() {
                // Reset camera position
                new TWEEN.Tween(this.camera.position)
                    .to({ x: 0, y: 0, z: 40 }, 1000)
                    .easing(TWEEN.Easing.Quadratic.InOut)
                    .start();
                
                // Reset heart rotation
                if (this.heart) {
                    new TWEEN.Tween(this.heart.rotation)
                        .to({ x: 0, y: 0, z: 0 }, 1000)
                        .easing(TWEEN.Easing.Quadratic.InOut)
                        .start();
                }
                
                // Reset camera target
                new TWEEN.Tween(this.camera)
                    .to({}, 1000)
                    .onUpdate(() => {
                        this.camera.lookAt(0, 0, 0);
                    })
                    .start();
                
                this.showNotification('View Reset', 'Camera returned to default position', 'info');
            }

            takeScreenshot() {
                // Render current frame
                this.renderer.render(this.scene, this.camera);
                
                // Get canvas data
                const dataURL = this.renderer.domElement.toDataURL('image/png');
                
                // Create download link
                const link = document.createElement('a');
                link.download = `CardioVis_${Date.now()}.png`;
                link.href = dataURL;
                link.click();
                
                this.showNotification('Screenshot Saved', 'Image downloaded to your device', 'success');
            }

            toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            }

            showSettings() {
                this.showNotification('Settings', 'Settings panel coming soon', 'info');
            }

            exitCurrentMode() {
                if (this.mode === 'learn') {
                    this.exitLearning();
                } else if (this.mode === 'assess') {
                    this.exitAssessment();
                }
                this.mode = 'explore';
                this.updateModeUI();
            }
        }

        // Initialize CardioVis Sim
        let cardioSim;
        window.addEventListener('DOMContentLoaded', () => {
            cardioSim = new CardioVisSim();
        });

        // Global UI functions
        function togglePanel(panelName) {
            const panel = document.getElementById(`${panelName}Panel`);
            const icon = document.getElementById(`${panelName}ToggleIcon`);
            
            panel.classList.toggle('collapsed');
            
            if (panelName === 'nav') {
                icon.textContent = panel.classList.contains('collapsed') ? '▶' : '◀';
            } else {
                icon.textContent = panel.classList.contains('collapsed') ? '◀' : '▶';
            }
        }

        function toggleCategory(categoryName) {
            const category = document.getElementById(`cat-${categoryName}`);
            category.classList.toggle('expanded');
        }

        function switchNavTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Load relevant content based on tab
            // This would load pathology or procedures content
        }

        function setMode(mode) {
            cardioSim.mode = mode;
            cardioSim.updateModeUI();
            
            switch(mode) {
                case 'learn':
                    cardioSim.startLearningModule(0);
                    break;
                case 'assess':
                    cardioSim.startAssessment();
                    break;
                case 'practice':
                    cardioSim.showNotification('Practice Mode', 'Surgical simulation coming soon', 'info');
                    break;
            }
        }

        function toggleRotation() { cardioSim?.toggleRotation(); }
        function toggleCrosssection() { cardioSim?.toggleCrosssection(); }
        function toggleXray() { cardioSim?.toggleXray(); }
        function toggleBloodFlow() { cardioSim?.toggleBloodFlow(); }
        function toggleLabels() { cardioSim?.toggleLabels(); }
        function resetView() { cardioSim?.resetView(); }
        function takeScreenshot() { cardioSim?.takeScreenshot(); }
        function toggleFullscreen() { cardioSim?.toggleFullscreen(); }
        function showSettings() { cardioSim?.showSettings(); }
        function closeNotification() {
            document.getElementById('notification').classList.remove('show');
        }
    </script>
</body>
</html>
