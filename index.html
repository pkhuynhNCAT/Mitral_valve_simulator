<!doctype html>
<html lang="en">
<head>
  <!-- =========================
       SECTION 01: HEAD • META & SEO
       ========================= -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <title>Mitral Valve Repair Simulator — Training & Assessment</title>

  <!-- Discoverability -->
  <meta name="description" content="A single-file, web-based, high-fidelity simulator for mitral valve repair & replacement. Practice suturing with stepwise AI co‑pilot guidance, rich annotations, and objective scoring." />
  <meta name="keywords" content="mitral valve, cardiac surgery, cardiothoracic, suturing, ring annuloplasty, valve replacement, simulation, education, training, assessment, WebGL, medical VR, surgical skills" />
  <meta name="application-name" content="MitralSim" />
  <meta name="generator" content="MitralSim Single-File Blueprint" />
  <meta name="referrer" content="no-referrer-when-downgrade" />
  <meta name="color-scheme" content="dark light" />

  <!-- Theming (dark/light-aware) -->
  <meta name="theme-color" content="#0b1220" media="(prefers-color-scheme: dark)" />
  <meta name="theme-color" content="#0e1530" media="(prefers-color-scheme: light)" />

  <!-- iOS/Android PWA niceties (kept local/single-file friendly) -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="MitralSim" />
  <meta name="format-detection" content="telephone=no" />

  <!-- Canonical & social (replace URL after you publish to GitHub Pages) -->
  <!-- TODO: update both href/content to your actual GitHub Pages URL, e.g., https://USERNAME.github.io/mitralsim/ -->
  <link rel="canonical" href="https://example.com/mitralsim/" />
  <meta property="og:url" content="https://example.com/mitralsim/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="MitralSim" />
  <meta property="og:title" content="Mitral Valve Repair Simulator — Training & Assessment" />
  <meta property="og:description" content="High‑fidelity, browser‑based suturing practice with AI co‑pilot, highlights, and objective scoring." />
  <meta property="og:locale" content="en_US" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Mitral Valve Repair Simulator — Training & Assessment" />
  <meta name="twitter:description" content="High‑fidelity, browser‑based suturing practice with AI co‑pilot, highlights, and objective scoring." />

  <!-- Single-file favicons (SVG data URIs) -->
  <!-- General favicon -->
  <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3CradialGradient id='g' cx='50%25' cy='45%25' r='60%25'%3E%3Cstop offset='0' stop-color='%2300d1ff'/%3E%3Cstop offset='1' stop-color='%2300a0c6'/%3E%3C/radialGradient%3E%3C/defs%3E%3Ccircle cx='32' cy='32' r='30' fill='url(%23g)'/%3E%3Cpath d='M16 32c5-8 11-12 16-12s11 4 16 12c-5 8-11 12-16 12s-11-4-16-12z' fill='%230b1220' opacity='.9'/%3E%3Ccircle cx='32' cy='32' r='30' fill='none' stroke='%23ffffff' stroke-opacity='.25'/%3E%3C/svg%3E" />
  <!-- Pinned tab / mask icon for Safari (monochrome) -->
  <link rel="mask-icon"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cpath d='M16 32c5-8 11-12 16-12s11 4 16 12c-5 8-11 12-16 12s-11-4-16-12z' fill='%23000'/%3E%3Ccircle cx='32' cy='32' r='30' fill='none' stroke='%23000'/%3E%3C/svg%3E"
        color="#00d1ff" />

  <!-- Optional: preload future in-document assets if/when you add them
       <link rel="preload" as="image" href="data:image/png;base64,..." />
       <link rel="preload" as="font" href="data:font/woff2;base64,..." type="font/woff2" crossorigin>
  -->

  <!-- Structured data for rich results (SoftwareApplication + HowTo for the suturing task) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@graph": [
      {
        "@type": "SoftwareApplication",
        "name": "MitralSim",
        "applicationCategory": "EducationalApplication",
        "operatingSystem": "Web",
        "isAccessibleForFree": true,
        "description": "High-fidelity, browser-based simulator for mitral valve repair and replacement with AI co-pilot guidance, overlays, and scoring.",
        "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" },
        "publisher": { "@type": "Organization", "name": "MitralSim Project" }
      },
      {
        "@type": "HowTo",
        "name": "Posterior leaflet interrupted suturing (training)",
        "description": "Stepwise guidance with highlights, bite zones, and safety checks.",
        "totalTime": "PT10M",
        "tool": [
          { "@type": "HowToTool", "name": "Needle driver" },
          { "@type": "HowToTool", "name": "Forceps" },
          { "@type": "HowToTool", "name": "Scissors" }
        ],
        "supply": [
          { "@type": "HowToSupply", "name": "3-0 polypropylene suture" }
        ],
        "step": [
          { "@type": "HowToStep", "name": "Identify target coaptation zone (P2)", "text": "Focus the field; confirm target zone is highlighted." },
          { "@type": "HowToStep", "name": "Mark first annular anchor", "text": "Mark P2 midpoint on the annulus within 2 mm tolerance." },
          { "@type": "HowToStep", "name": "Needle bite: ventricular → atrial at P2", "text": "Maintain 35–55° needle angle; bite depth 1.5–3.0 mm; spacing 2–3 mm." }
        ]
      }
    ]
  }
  </script>

  <!-- =========================
       SECTION 02: HEAD • DESIGN TOKENS & GLOBAL CSS
       ========================= -->
  <style>
    /* ---------- Design Tokens ---------- */
    :root {
      /* Color system (dark by default) */
      --bg-0: #05070c;   /* page background (deep) */
      --bg-1: #0b1220;   /* app background */
      --bg-2: #111a2e;   /* bars & panels base */
      --surface-1: #0f1830;
      --surface-2: #14213d;
      --surface-3: #1a2a4f;

      --fg-0: #ffffff;   /* primary text */
      --fg-1: #cbd5e1;   /* secondary text */
      --fg-2: #9fb0c9;   /* tertiary text */
      --muted: #8b9bb3;

      --accent:   #00d1ff;  /* cyan */
      --accent-2: #ff2d55;  /* rose */
      --ok:   #2ecc71;
      --warn: #ffb020;
      --bad:  #ff4d4f;

      /* FX / outlines */
      --focus: color-mix(in oklab, var(--accent) 80%, white);
      --glow: 0 0 0 2px color-mix(in oklab, var(--accent) 40%, transparent),
               0 0 0 6px color-mix(in oklab, var(--accent) 20%, transparent);

      /* Spacing scale */
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;

      /* Radii */
      --r-xs: 8px;
      --r-sm: 10px;
      --r:    12px;
      --r-lg: 18px;

      /* Shadows (elevation) */
      --shadow-1: 0 6px 16px rgba(0,0,0,.28);
      --shadow-2: 0 10px 30px rgba(0,0,0,.32);
      --shadow-3: 0 14px 42px rgba(0,0,0,.40);

      /* Typography */
      --font-ui: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;

      /* Fluid type scale */
      --fs-xs: clamp(12px, .78rem, 13px);
      --fs-sm: clamp(13px, .88rem, 14px);
      --fs-md: clamp(14px, .95rem + .1vw, 16px);
      --fs-lg: clamp(16px, 1rem + .4vw, 18px);
      --fs-xl: clamp(18px, 1.05rem + .8vw, 22px);

      /* Motion & timing */
      --dur-1: 120ms;
      --dur-2: 200ms;
      --dur-3: 320ms;
      --ease: cubic-bezier(.2, .8, .2, 1);

      /* Layout */
      --rail-left-min: 260px;
      --rail-left-max: 360px;
      --rail-right-min: 300px;
      --rail-right-max: 420px;
    }

    /* Light theme overrides (auto if user prefers light) */
    @media (prefers-color-scheme: light) {
      :root {
        --bg-1: #f8fafc;
        --bg-2: #eef2f7;
        --surface-1: #ffffff;
        --surface-2: #f3f6fb;
        --surface-3: #e9eef7;

        --fg-0: #0b1220;
        --fg-1: #182338;
        --fg-2: #3a4a65;
        --muted: #5d6f8d;

        --accent: #007aff;
        --accent-2: #ff2d55;

        --shadow-1: 0 4px 14px rgba(12,20,40,.14);
        --shadow-2: 0 8px 24px rgba(12,20,40,.18);
        --shadow-3: 0 14px 42px rgba(12,20,40,.22);
      }
    }

    /* High-contrast helper (toggled by .high-contrast on #app) */
    #app.high-contrast {
      filter: contrast(1.15) saturate(1.08);
    }

    /* ---------- Base / Reset ---------- */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; }
    html { -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }
    body {
      margin: 0;
      background: var(--bg-1);
      color: var(--fg-1);
      font: 14px/1.5 var(--font-ui);
      accent-color: var(--accent);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overscroll-behavior: contain;
    }
    ::selection { background: color-mix(in oklab, var(--accent) 30%, transparent); color: var(--fg-0); }

    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }

    .visually-hidden {
      position: absolute !important;
      height: 1px; width: 1px;
      overflow: hidden; clip: rect(1px,1px,1px,1px);
      white-space: nowrap;
    }

    /* ---------- Layout Shell ---------- */
    #app {
      display: grid;
      grid-template-rows: auto 1fr auto;
      height: 100vh;
      background: linear-gradient(180deg, var(--bg-1), var(--bg-0));
    }
    .topbar, .bottombar {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-4);
      background: linear-gradient(180deg, color-mix(in oklab, var(--bg-2) 90%, transparent), var(--surface-1));
      border-bottom: 1px solid color-mix(in oklab, var(--fg-2) 10%, transparent);
      box-shadow: var(--shadow-2);
      z-index: 20;
    }
    .bottombar { border-top: 1px solid color-mix(in oklab, var(--fg-2) 10%, transparent); border-bottom: none; }

    .main {
      min-height: 0; /* allow center to shrink within grid */
      display: grid;
      grid-template-columns:
        clamp(var(--rail-left-min), 26vw, var(--rail-left-max))
        1fr
        clamp(var(--rail-right-min), 28vw, var(--rail-right-max));
      gap: var(--space-3);
      padding: var(--space-3);
    }
    /* Responsive collapse of rails on narrow viewports */
    @media (max-width: 1200px) {
      .main {
        grid-template-columns: 1fr;
      }
      .main > aside[aria-label="Instruments"],
      .main > aside[aria-label="AI Co‑Pilot"] {
        order: 1;
      }
      .main > .stage { order: 0; }
    }

    /* ---------- Panels & Common UI ---------- */
    .panel {
      background: linear-gradient(180deg, color-mix(in oklab, var(--surface-1) 86%, transparent), color-mix(in oklab, var(--surface-2) 80%, transparent));
      border: 1px solid color-mix(in oklab, var(--fg-2) 12%, transparent);
      border-radius: var(--r);
      padding: var(--space-4);
      box-shadow: var(--shadow-1);
      backdrop-filter: blur(6px) saturate(1.02);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: color-mix(in oklab, var(--surface-3) 65%, transparent);
      border: 1px solid color-mix(in oklab, var(--fg-2) 14%, transparent);
      color: var(--fg-1);
      border-radius: 999px;
      font-size: var(--fs-sm);
      line-height: 1;
    }

    button, select {
      font: 600 14px/1 var(--font-ui);
      color: var(--fg-0);
      background: var(--surface-2);
      border: 1px solid color-mix(in oklab, var(--fg-2) 18%, transparent);
      border-radius: var(--r-sm);
      padding: 10px 14px;
      cursor: pointer;
      transition: transform var(--dur-1) var(--ease), background var(--dur-2) var(--ease), box-shadow var(--dur-2) var(--ease);
    }
    button:hover, select:hover { background: color-mix(in oklab, var(--surface-2) 80%, var(--accent) 20%); }
    button:active { transform: translateY(1px) scale(.995); }
    button:disabled { opacity: .6; cursor: not-allowed; }

    button.primary {
      background: var(--accent);
      color: #001018;
      border-color: color-mix(in oklab, var(--accent) 70%, #000);
      box-shadow: 0 4px 16px color-mix(in oklab, var(--accent) 28%, transparent);
    }
    button.primary:hover { box-shadow: 0 6px 20px color-mix(in oklab, var(--accent) 36%, transparent); }

    button.ghost {
      background: transparent;
      color: var(--fg-1);
      border-color: color-mix(in oklab, var(--fg-2) 24%, transparent);
    }

    /* Accessible focus ring */
    :focus-visible {
      outline: 2px solid var(--focus);
      outline-offset: 2px;
      box-shadow: var(--glow);
    }

    /* ---------- Stage (Canvas + Overlays) ---------- */
    .stage {
      position: relative;
      background: radial-gradient(120% 100% at 50% 0%, #0a0f1e, #04070f);
      border-radius: var(--r);
      overflow: hidden;
      min-height: 380px;
      box-shadow: var(--shadow-3);
      isolation: isolate; /* keeps glows inside */
    }
    #gl { width: 100%; height: 100%; display: block; touch-action: none; user-select: none; }
    .overlay { position: absolute; inset: 0; pointer-events: none; }
    .legend { position: absolute; right: 16px; top: 16px; backdrop-filter: blur(8px); }
    .hud { position: absolute; left: 16px; bottom: 16px; }
    .tooltip {
      position: fixed; inset: auto auto 20px 20px; max-width: 360px;
      pointer-events: none;
      background: color-mix(in oklab, var(--surface-1) 92%, transparent);
      border: 1px solid color-mix(in oklab, var(--fg-2) 16%, transparent);
      border-radius: var(--r);
      padding: var(--space-4);
      box-shadow: var(--shadow-2);
      color: var(--fg-1);
      font-size: var(--fs-sm);
    }

    /* ---------- Lists / Steps ---------- */
    .steps { margin: 0; padding-left: 0; counter-reset: step; }
    .steps li {
      list-style: none;
      margin: 0 0 var(--space-3);
      padding: var(--space-3);
      border-radius: var(--r-sm);
      background: color-mix(in oklab, var(--surface-3) 50%, transparent);
      border: 1px solid color-mix(in oklab, var(--fg-2) 14%, transparent);
      position: relative;
    }
    .steps li::before {
      counter-increment: step;
      content: counter(step);
      position: absolute;
      left: -10px; top: -10px;
      width: 28px; height: 28px; border-radius: 50%;
      display: grid; place-items: center;
      font-weight: 700; font-size: 12px;
      color: #001018;
      background: var(--accent);
      border: 2px solid color-mix(in oklab, var(--accent) 70%, #000);
      box-shadow: 0 6px 18px color-mix(in oklab, var(--accent) 30%, transparent);
    }
    .steps li.active {
      outline: 2px solid var(--accent);
      background: color-mix(in oklab, var(--accent) 12%, var(--surface-3));
    }

    /* ---------- Score & Telemetry ---------- */
    .score-grid { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }
    progress { width: 100%; height: 8px; border: none; background: color-mix(in oklab, var(--surface-3) 60%, transparent); border-radius: 999px; overflow: hidden; }
    progress::-webkit-progress-bar { background: transparent; }
    progress::-webkit-progress-value { background: var(--accent); }
    progress::-moz-progress-bar { background: var(--accent); }

    /* ---------- Form Inputs ---------- */
    select {
      background: var(--surface-2);
      color: var(--fg-0);
      padding-right: 34px;
    }

    /* ---------- Dialog ---------- */
    dialog.panel {
      border: none; /* panel already has border */
      padding: 0; /* use panel padding */
      max-width: min(720px, 92vw);
    }
    dialog::backdrop {
      background: rgba(2, 8, 24, .6);
      backdrop-filter: blur(3px);
    }

    /* ---------- Micro-animations ---------- */
    @keyframes pulse {
      0%   { transform: scale(1);   opacity: .8; }
      70%  { transform: scale(1.06); opacity: .2; }
      100% { transform: scale(1.08); opacity: 0; }
    }
    .pulse { animation: pulse 1200ms var(--ease) infinite; }

    /* Respect reduced motion */
    @media (prefers-reduced-motion: reduce) {
      * { animation-duration: 0.001ms !important; animation-iteration-count: 1 !important; transition-duration: 0.001ms !important; scroll-behavior: auto !important; }
    }

    /* ---------- Scrollbars (nice-to-have) ---------- */
    *::-webkit-scrollbar { width: 10px; height: 10px; }
    *::-webkit-scrollbar-thumb {
      background: color-mix(in oklab, var(--surface-3) 80%, transparent);
      border: 2px solid transparent; border-radius: 999px; background-clip: padding-box;
    }
    *::-webkit-scrollbar-thumb:hover { background: color-mix(in oklab, var(--accent) 24%, var(--surface-3)); }

    /* ---------- Typography helpers ---------- */
    h1, h2, h3, h4 { color: var(--fg-0); margin: 0 0 var(--space-3); line-height: 1.2; }
    h1 { font-size: var(--fs-xl); }
    h2 { font-size: var(--fs-lg); }
    h3 { font-size: var(--fs-md); }
    h4 { font-size: var(--fs-sm); }
    small { font-size: var(--fs-xs); color: var(--fg-2); }

    /* ---------- Utility classes ---------- */
    .grid { display: grid; gap: var(--space-3); }
    .row { display: flex; flex-wrap: wrap; gap: var(--space-3); align-items: center; }
    .mt-0 { margin-top: 0 !important; }
    .mb-0 { margin-bottom: 0 !important; }
    .w-100 { width: 100% !important; }
  </style>
  <!-- =========================
       SECTION 03: HEAD • EMBEDDED SVG ICON SPRITE
       ========================= -->
  <svg width="0" height="0" class="visually-hidden" aria-hidden="true">
    <symbol id="i-play" viewBox="0 0 24 24"><path fill="currentColor" d="M8 5v14l11-7z"/></symbol>
    <symbol id="i-pause" viewBox="0 0 24 24"><path fill="currentColor" d="M6 5h4v14H6zM14 5h4v14h-4z"/></symbol>
    <symbol id="i-hand" viewBox="0 0 24 24"><path fill="currentColor" d="M5 8l2-2 4 4 6-6 2 2-8 8z"/></symbol>
    <symbol id="i-warning" viewBox="0 0 24 24"><path fill="currentColor" d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2V9h2v5z"/></symbol>
    <symbol id="i-camera" viewBox="0 0 24 24"><path fill="currentColor" d="M4 7h4l2-2h4l2 2h4v12H4z"/></symbol>
    <!-- Add more as needed -->
  </svg>

  <!-- =========================
       SECTION 04: HEAD • AUDIO & HAPTICS PLACEHOLDERS
       ========================= -->
  <!-- Optional: base64 audio or blank sources to be filled later -->
  <audio id="snd-ok" preload="auto"></audio>
  <audio id="snd-warn" preload="auto"></audio>
  <audio id="snd-bad" preload="auto"></audio>
</head>

<body>
  <!-- =========================
       SECTION 05: APP SHELL & ACCESSIBILITY LANDMARKS
       ========================= -->
  <a class="visually-hidden" href="#main">Skip to main content</a>
  <div id="app" class="" role="application" aria-label="Mitral Valve Simulator">

    <!-- =========================
         SECTION 06: UI • TOP BAR / MODE SWITCH
         ========================= -->
    <header class="topbar" aria-label="Top bar">
      <div class="chip" aria-label="App title">MitralSim <small>v0.1</small></div>
      <div class="chip">Scenario:
        <select id="scenario">
          <option value="suturing-basic">Posterior leaflet interrupted suturing</option>
          <option value="ring-annuloplasty">Ring annuloplasty (sim)</option>
          <option value="replacement">MV replacement (sim)</option>
        </select>
      </div>
      <div class="chip">Mode:
        <select id="mode">
          <option value="training">Training</option>
          <option value="practice">Practice</option>
          <option value="assessment">Assessment</option>
        </select>
      </div>
      <div style="margin-left:auto; display:flex; gap:8px;">
        <label class="chip"><input id="toggle-contrast" type="checkbox" /> High contrast</label>
        <button id="open-onboarding" class="ghost">Help</button>
        <button id="take-screenshot" title="Save snapshot"><svg width="18" height="18"><use href="#i-camera"/></svg></button>
      </div>
    </header>

    <main id="main" class="main" aria-label="Main workspace">
      <!-- =========================
           SECTION 07: UI • LEFT RAIL — INSTRUMENTS & TOOLS
           ========================= -->
      <aside class="panel" aria-label="Instruments">
        <h3>Instruments</h3>
        <ul id="tools">
          <li><label><input type="radio" name="tool" value="needle-driver" checked> Needle driver</label></li>
          <li><label><input type="radio" name="tool" value="forceps"> Forceps</label></li>
          <li><label><input type="radio" name="tool" value="scissors"> Scissors</label></li>
          <li><label><input type="radio" name="tool" value="suction"> Suction</label></li>
          <li><label><input type="radio" name="tool" value="ring-sizer"> Ring sizer</label></li>
        </ul>
        <hr/>
        <h4>Instrument Telemetry</h4>
        <div class="score-grid">
          <span>Tip force</span><span id="tele-force" style="text-align:right">0.0 N</span>
          <span>Grip angle</span><span id="tele-angle" style="text-align:right">0°</span>
          <span>Collision</span><span id="tele-coll" style="text-align:right">None</span>
        </div>
      </aside>

      <!-- =========================
           SECTION 08: UI • CENTER STAGE — SIMULATION CANVAS
           ========================= -->
      <section class="stage panel" aria-label="Simulation Stage">
        <canvas id="gl" aria-label="3D mitral valve scene"></canvas>
        <svg id="overlay" class="overlay" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <!-- dynamic annotations/hotspots/rulers rendered here -->
        </svg>
        <!-- Floating legend & HUD -->
        <div class="legend panel">
          <h4>Legend</h4>
          <ul style="margin:0; padding-left:18px;">
            <li><span style="color:var(--accent)">Cyan</span> = Target bite zone</li>
            <li><span style="color:var(--ok)">Green</span> = Valid stitch</li>
            <li><span style="color:var(--warn)">Amber</span> = Shallow/steep angle</li>
            <li><span style="color:var(--bad)">Red</span> = Chordal injury risk</li>
          </ul>
        </div>
        <div class="hud panel">
          <div>Step <b id="step-idx">1</b>/<span id="step-total">—</span> • <span id="step-title">—</span></div>
          <div>Timer: <span id="timer">00:00</span></div>
        </div>
        <div id="tooltip" class="tooltip panel" role="status" aria-live="polite">Welcome. Press <b>?</b> for help.</div>
      </section>

      <!-- =========================
           SECTION 10: UI • RIGHT RAIL — AI CO-PILOT
           ========================= -->
      <aside class="panel" aria-label="AI Co‑Pilot">
        <h3>AI Co‑Pilot</h3>
        <p id="copilot-summary">Follow the highlighted path for your first posterior leaflet stitch.</p>
        <ol id="step-list" class="steps">
          <!-- li items injected per step -->
        </ol>
        <hr/>
        <h4>Feedback</h4>
        <div id="feedback">
          <p>Errors & suggestions will appear here.</p>
        </div>
      </aside>
    </main>

    <!-- =========================
         SECTION 11: UI • BOTTOM BAR — TRANSPORT & SESSION CONTROLS
         ========================= -->
    <footer class="bottombar" aria-label="Controls">
      <div style="display:flex; gap:8px;">
        <button id="btn-start" class="primary"><svg width="18" height="18"><use href="#i-play"/></svg> Start</button>
        <button id="btn-pause"><svg width="18" height="18"><use href="#i-pause"/></svg> Pause</button>
        <button id="btn-reset" class="ghost">Reset</button>
        <button id="btn-undo" class="ghost">Undo</button>
        <button id="btn-redo" class="ghost">Redo</button>
      </div>
      <div style="margin-left:auto; display:flex; gap:12px; align-items:center;">
        <div class="chip">Score: <b id="score">0</b></div>
        <div class="chip">Safety: <b id="score-safety">100%</b></div>
        <div class="chip">Accuracy: <b id="score-accuracy">0%</b></div>
        <div class="chip">Efficiency: <b id="score-efficiency">—</b></div>
      </div>
    </footer>
  </div>

  <!-- =========================
       SECTION 12: UI • DIALOGS & SHEETS
       ========================= -->
  <dialog id="dlg-onboarding" class="panel">
    <h3>Welcome</h3>
    <p>This simulator guides you through mitral valve suturing with stepwise highlights and scoring.</p>
    <ul>
      <li><b>Training</b>: step‑by‑step with enforced sequence.</li>
      <li><b>Practice</b>: guided but flexible sequence.</li>
      <li><b>Assessment</b>: silent mode; full scoring.</li>
    </ul>
    <button id="ob-ok" class="primary">Let’s begin</button>
  </dialog>

  <!-- =========================
       SECTION 13–28: SCRIPTS (MODULE)
       ========================= -->
  <script type="module">
  // =========================
  // SECTION 13: BOOT & CAPABILITY CHECKS
  // =========================
  const caps = {
    webgl2: !!document.createElement('canvas').getContext('webgl2'),
    reducedMotion: window.matchMedia('(prefers-reduced-motion: reduce)').matches
  };
  if (!caps.webgl2) {
    document.body.innerHTML = '<div style="padding:24px;color:white;font:16px/1.5 var(--font-ui)">'+
      '<h2>WebGL2 not available</h2><p>This simulator needs a modern browser/GPU. Try Chrome/Edge/Firefox on desktop.</p></div>';
    throw new Error('WebGL2 required');
  }

  // =========================
  // SECTION 14: STATE STORE & EVENT BUS
  // =========================
  const State = {
    mode: 'training',
    scenario: 'suturing-basic',
    stepIndex: 0,
    timerStart: 0,
    score: { total:0, safety:100, accuracy:0, efficiency:null },
    telemetry: { forceN:0, angleDeg:0, collisions:0 },
    flags: { highContrast:false },
  };
  const Bus = new EventTarget();
  const emit = (type, detail) => Bus.dispatchEvent(new CustomEvent(type, { detail }));

  // =========================
  // SECTION 15: GEOMETRY & ASSETS BUILDER (PARAMETRIC)
  // =========================
  // Placeholder stubs; you will fill with mesh generation later.
  const Assets = {};
  function buildMitralApparatus(params={}) {
    // TODO: annulus spline, leaflets (A/P segments), chordae trees, papillary anchors
    return { meshes:{}, bounds:{}, landmarks:{} };
  }

  // =========================
  // SECTION 16: RENDERER & MATERIALS
  // =========================
  let gl, renderer;
  function initRenderer() {
    const canvas = document.getElementById('gl');
    gl = canvas.getContext('webgl2', { antialias:true, alpha:false });
    // TODO: init program(s), FBOs, simple SSS / wetness shading
    onResize();
    window.addEventListener('resize', onResize);
  }
  function onResize(){
    const c = gl.canvas; const dpr = Math.min(window.devicePixelRatio||1, 2);
    c.width = c.clientWidth * dpr; c.height = c.clientHeight * dpr;
    // TODO: viewport update
  }
  function renderFrame(t){
    // TODO: draw valve, instruments, suture thread, overlays
    requestAnimationFrame(renderFrame);
  }

  // =========================
  // SECTION 17: CAMERA & INTERACTION
  // =========================
  const Input = { pointer:{down:false,x:0,y:0}, tool:'needle-driver' };
  function bindInteraction(){
    const canvas = document.getElementById('gl');
    canvas.addEventListener('pointerdown', e => { Input.pointer.down=true; });
    canvas.addEventListener('pointerup',   e => { Input.pointer.down=false; });
    canvas.addEventListener('pointermove', e => { Input.pointer.x=e.offsetX; Input.pointer.y=e.offsetY; });
    document.querySelector('#tools').addEventListener('change', e=>{
      if (e.target.name==='tool') Input.tool = e.target.value;
    });
  }

  // =========================
  // SECTION 18: PHYSICS LITE (SURFACE + THREAD)
  // =========================
  const Physics = {
    // TODO: mass-spring for leaflets; constraint chain for suture
  };

  // =========================
  // SECTION 19: SUTURING ENGINE
  // =========================
  const Suturing = {
    stitches: [],
    takeBite(worldPt, normal, options){
      // TODO: log & validate bite depth/spacing/angle; update scoring hooks
    },
    evaluateQuality(){ /* TODO */ },
  };

  // =========================
  // SECTION 20: SCENARIO & STEP MACHINE (Training/Practice)
  // =========================
  const Scenarios = {
    "suturing-basic": {
      title: "Posterior leaflet interrupted suturing",
      steps: [
        { id:"prep-01", title:"Identify target coaptation zone",
          highlight:{ region:"P2", type:"fill" },
          goal:{ gaze:true, duration:2000 },
          rubric:{ weight:0.05 } },
        { id:"mark-01", title:"Mark first annular anchor (P2 midpoint)",
          highlight:{ region:"annulus-P2", type:"ring" },
          goal:{ clickWithinMm:2 },
          rubric:{ weight:0.10, accuracyMm:[0,1,2,4] } },
        { id:"bite-01", title:"Needle bite: ventricular→atrial at P2",
          highlight:{ region:"leaflet-P2", type:"zone" },
          goal:{ biteDepthMm:[1.5,3.0], angleDeg:[35,55], spacingMm:[2.0,3.0] },
          rubric:{ weight:0.25, safetyPenaltyChordInjury:0.3 } },
        // ...more steps: symmetric bites, knot tying, saline test, etc.
      ]
    }
  };

  // =========================
  // SECTION 21: AI CO-PILOT LOGIC (Hints, Errors, Remediation)
  // =========================
  function setMode(v){ State.mode=v; emit('mode', v); }
  function gotoStep(i){
    State.stepIndex = Math.max(0, Math.min(i, getSteps().length-1));
    updateStepUI();
    focusCameraToCurrentStep();
    speak(`Step ${State.stepIndex+1}. ${getSteps()[State.stepIndex].title}`);
  }
  function getSteps(){ return Scenarios[State.scenario].steps; }
  function analyzeAndGuide(event){
    // TODO: inspect last action; classify (angle shallow, bite too deep, near chordae, spacing off)
    // then: highlight error region, suggest correction, adjust target tolerances if practice mode
  }

  // =========================
  // SECTION 22: SCORING & RUBRIC
  // =========================
  const Scoring = {
    weights:{ accuracy:0.5, safety:0.3, efficiency:0.2 },
    metrics:{ accuracy:0, safety:1.0, efficiency:0 },
    compute(){
      const total = (this.metrics.accuracy*this.weights.accuracy) +
                    (this.metrics.safety  *this.weights.safety)   +
                    (this.metrics.efficiency*this.weights.efficiency);
      State.score.total = Math.round(total*100);
      updateScoreUI();
    }
  };

  // =========================
  // SECTION 23: OVERLAY & ANNOTATION RENDERER (SVG)
  // =========================
  function drawHighlight(opts){ /* TODO: add <circle>/<path> to #overlay; animate pulse */ }
  function drawRuler(a,b,mm){ /* TODO: measurement line with mm labels */ }

  // =========================
  // SECTION 24: AUDIO/VOICE & TEXT-TO-CUE
  // =========================
  function speak(text){
    // Optional: use SpeechSynthesis if available; always show text in tooltip for accessibility
    document.getElementById('tooltip').textContent = text;
    if ('speechSynthesis' in window) { window.speechSynthesis.cancel(); window.speechSynthesis.speak(new SpeechSynthesisUtterance(text)); }
  }

  // =========================
  // SECTION 25: PERSISTENCE & EXPORT
  // =========================
  function saveSession(){
    const payload = { State, Suturing };
    localStorage.setItem('mitralsim-session', JSON.stringify(payload));
  }
  function exportSnapshot(){
    // TODO: draw overlay into offscreen canvas + gl canvas, export PNG; also export JSON of attempts
  }

  // =========================
  // SECTION 26: ACCESSIBILITY & LOCALIZATION
  // =========================
  const STR = { en: { start:"Start", pause:"Pause" } }; // placeholder

  // =========================
  // SECTION 27: DEBUG & QA PANEL
  // =========================
  const Debug = { enabled:false };

  // =========================
  // SECTION 28: INIT & SAFE FALLBACK
  // =========================
  function updateScoreUI(){
    document.getElementById('score').textContent = State.score.total;
    document.getElementById('score-safety').textContent = Math.round(Scoring.metrics.safety*100)+'%';
    document.getElementById('score-accuracy').textContent = Math.round(Scoring.metrics.accuracy*100)+'%';
  }
  function updateStepUI(){
    document.getElementById('step-idx').textContent = State.stepIndex+1;
    document.getElementById('step-total').textContent = getSteps().length;
    document.getElementById('step-title').textContent = getSteps()[State.stepIndex].title;
    // Populate right-rail steps
    const ol = document.getElementById('step-list'); ol.innerHTML='';
    getSteps().forEach((s,idx)=>{
      const li = document.createElement('li'); li.textContent = s.title; if (idx===State.stepIndex) li.classList.add('active'); ol.appendChild(li);
    });
  }

  // Wire UI
  document.getElementById('mode').addEventListener('change', e=>setMode(e.target.value));
  document.getElementById('scenario').addEventListener('change', e=>{ State.scenario=e.target.value; gotoStep(0); });
  document.getElementById('btn-start').addEventListener('click', ()=>{ State.timerStart=performance.now(); speak('Session started'); });
  document.getElementById('btn-reset').addEventListener('click', ()=>{ location.reload(); });
  document.getElementById('toggle-contrast').addEventListener('change', e=>{ document.getElementById('app').classList.toggle('high-contrast', e.target.checked); });
  document.getElementById('take-screenshot').addEventListener('click', exportSnapshot);
  document.getElementById('open-onboarding').addEventListener('click', ()=>document.getElementById('dlg-onboarding').showModal());
  document.getElementById('ob-ok').addEventListener('click', ()=>document.getElementById('dlg-onboarding').close());

  // Start
  initRenderer(); bindInteraction();
  gotoStep(0); updateScoreUI();
  requestAnimationFrame(renderFrame);
  </script>
</body>
</html>
